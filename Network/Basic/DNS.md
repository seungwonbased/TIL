# DNS (Domain Name System)

- 도메인 이름과 IP 주소의 대응 관계를 데이터베이스 형태로 저장하고 제공하는 서비스 
- 호스트의 도메인 이름을 호스트의 IP 주소로 바꾸거나 그 반대의 변환을 수행할 수 있도록 하기 위해 개발

## DNS 제공 서비스

- **호스트 이름을 IP 주소로 변환**
- **Host Aliasing**
	- 복잡한 호스트 이름을 가진 호스트는 하나 이상의 별명을 가질 수 있음
	- 여러 개의 도메인을 가질 수 있음
	- 정식 호스트 이름을 Canonial Hostname이라고 함
- **Mail Server Aliasing**
	- 메일 서버와 웹 서버 모두 같은 호스트 이름을 갖는 것을 허용 (e.g., google.com)
- **부하 분산**
	- DNS는 중복 웹서버와 같은 여러 중복 서버 사이에 부하를 분산하기 위해 사용
	- 하나의 호스트 이름으로 여러 IP 주소에 상응될 수 있음

## DNS 구조

![dns](https://github.com/seungwonbased/TIL/blob/main/Network/assets/dns1.png)

- **루트 DNS 서버**
	- 전세계적으로 1000개 이상
		- 이들은 13개의 Root 서버의 사본
	- 12개의 기관에서 관리
	- TLD 서버의 IP 주소들을 제공
- **TLD (Top-Level Domain) (최상위 레벨) 도메인 서버**
	- com, org, net, edu, gov, kr, uk, fr 와 같은 상위 레벨 도메인
	- 책임 DNS 서버에 대한 IP 주소를 제공
- **Authoritative (책임) DNS 서버**
	- 인터넷에 접근하기 쉬운 호스트 (웹 서버, 메일 서버 등)를 가진 기관은 공개적인 DNS 레코드를 제공
	- 기관의 DNS 서버는 DNS 레코드를 가지고 있음
- **Local (로컬) DNS 서버**
	- DNS 계층에 속하지 않으며, 대신 IP 주소를 제공하거나 질의
	- 웹 캐시와 비슷한 역할

## DNS 명명 규칙

- 도메인 계층은 최대 128계층까지 구성할 수 있음    
- 계층별 길이는 최대 63byte까지 사용할 수 있으며, 도메인 계층 구분자(".")를 포함해 전체 도메인 네임의 길이는 최대 255byte까지 사용할 수 있음
- 문자는 알파벳, 숫자, "-"만 사용할 수 있으며, 대소문자를 구분하지 않음

## Root Domain

- 도메인을 구성하는 최상위 영역
- DNS 서버는 사용자가 쿼리한 도메인에 대한 값을 직접 갖고 있거나 캐시에 저장된 정보를 이용해서 응답 
- DNS 서버에 해당 도메인의 정보가 없으면 루트 도메인을 관리하는 루트 DNS에 쿼리
- 루트 DNS는 전 세계에 13개가 있고, DNS 서버를 설치하면 루트 DNS의 IP 주소를 기록한 힌트(Hint) 파일을 가지고 있어 루트 DNS 관련 정보를 별도로 설정할 필요가 없음

## TLD (Top-Level Domain)

- IANA(Internet Assigned Numbers Authority)에서 6가지 유형으로 구분    
	- https://www.iana.org/domains/root/db
- 종류
	- **generic (gTLD)**
		- 특별한 제한없이 일반적으로 사용되는 최상위 도메인으로 세 글자 이상으로 구성 
		- 1980년대 7개의 gTLD (필요에 의해 새로운 gTLD가 지속적으로 만들어지고 있음)
			- com
			- edu
			- gov
			- int
			- mil
			- net
			- org
	- **country-code (ccTLD)**
		- 국가 최상위 도메인으로 ISO 3166 표준에 의해 규정된 두 글자의 국가 코드를 사용
			- 우리나라는 kr을 사용하고, 영국은 ISO 3166 표준이 아닌 uk라는 별도 ccTLD를 사용
		- 일반적으로 ccTLD를 사용하는 경우, Second Level TLD에는 gTLD에서 구분한 것처럼 사이트 용도에 따른 코드를 사용
			- co.kr, go.kr, ...
		- 우리나라는 gTLD를 두 글자로 줄여 사용하지만 호주나 대만에서는 그대로 사용
			- com.au, gov.au, com.tw, gov.tw, ...
	- **sponsored(sTLD)**
		- 특정 목적을 위한 스폰서를 두고 있는 최상위 도메인
		- 스폰서는 특정 민족공동체, 전문가 집단, 지리적 위치 등이 속할 수 있음
		- .aero, .asia, .edu, .museum ....
	- **infrastructure**
		- 운용상 중요한 인프라 식별자 공간을 지원하기 위해 전용으로 사용되는 최상위 도메인
		- .arpa, ...
	- **generic-restricted(grTLD)**
		- 특정 기준을 충족하는 사람이나 단체가 사용할 수 있는 최상위 도메인
		- .biz, .name, .pro, ...
	- **test(tTLD)**
		- IDN 개발 프로세스에서 테스트 목적으로 사용하는 최상위 도메인
		- .test, ...

## DNS 동작 방식

![dns](https://github.com/seungwonbased/TIL/blob/main/Network/assets/dns3.png)

- 재귀적 질의와 반복적 질의는 DNS 질의 메시지에 헤더 플래그 정보에 의해 결정됨
	- DNS 질의 메시지 헤더의 RD(Recursive Desired) 플래그가 1로 세팅된 경우, 재귀적 질의(Recursive Query)
	- 반면 이 플래그가 0인 경우, 반복적 질의(Interactive Query)

### Recursive Query

- 상대 네임 서버에게 자신을 대신하여 원하는 도메인의 데이터를 인터넷에서 조회하여 응답해달라는 의미  
- 네임 서버는 캐시 데이터 영역에서 질의된 대상 데이터를 조회
	- 데이터가 없는 경우, 리졸버 루틴을 가동시켜 인터넷 루트 네임 서버로부터 질의 절차를 순차적으로 수행하여 질의 대상 데이터를 파악해 나간 후 최종 데이터를 파악한 경우 응답 처리

### Iterative Query

- 루트 네임 서버로부터 도메인의 트리 형태 계층 구조를 따라 순차적으로 반복하여 진행하는 질의 (위임된 네임서버 정보를 따라 질의)

## DNS Cache

### Local DNS Server

- Local DNS 서버는 정보를 수집하여 자신의 저장 장치에 저장
- 매번 Client에게 질의를 받을 때마다 상위 도메인 서버에 질의를 할 수 없기 때문에 새로 질의를 하게 되면 DNS 캐싱을 하여 저장
- 이러한 정보들도 계속 가지지는 않음
	- 계속 저장하게 되면 이미 바뀐 정보가 아닌 이전 정보를 보낼 수 도 있기 때문
	- 주기적으로 내용을 업데이트

### Client

![dns](https://github.com/seungwonbased/TIL/blob/main/Network/assets/dns2.png)

- 클라이언트에서도 DNS 정보를 캐싱
- DNS 정보는 hosts.txt 파일에 저장되어 있으며 주기적으로 내용을 삭제
- DNS 정보가 Client에 저장되어 있으면 매우 빠른 처리가 가능하기에 유리
	- 만약 이 파일에 DNS 정보가 없다면 앞서 설명한 것처럼 DNS 서버에게 질의를 하게 됨
	- ARP 캐시 테이블과 매우 흡사
		- ARP가 Mac 주소를 저장하듯 DNS는 IP를 저장

## DNS 레코드

- DNS 상에서 도메인에 관한 설정을 하기 위해 사용되는 일련의 문자들을 DNS 레코드라고 통칭

|레코드 종류|내용|
|---|---|
|A (IPv4 host)|도메인 주소를 IPv4 주소로 매핑|
|AAAA (IPv6 host)|도메인 주소를 IPv6 주소로 매핑|
|CNAME (별칭)|도메인 주소에 대한 별칭|
|SOA (권한 시작)|본 영역 데이터에 대한 권한|
|NS (도메인의 네임 서버)|본 영역에 대한 네임 서버|
|MX (메일 교환기)|도메인에 대한 메일 서버 정보|
|PTR (포인터)|IP 주소를 도메인에 매핑 (역방향)|
|TXT (레코드)|도메인에 대한 일반 텍스트|

### A (IPv4) 레코드

- A 레코드는 기본 레코드로 도메인 주소를 IPv4 주소로 변환하는 레코드
- 사용자가 DNS에 질의한 도메인 주소를 A 레코드에 설정한 IP 주소로 응답
- 보통 하나의 A 레코드에는 한 개의 도메인 주소와 한 개의 IP 주소로 1:1 매핑
- 동일한 도메인을 가진 A 레코드를 여러 개 만들어서 다른 IP 주소와 매핑할 수 있음 (로드 밸런싱)

### AAAA(IPv6) 레코드

- AAAA 레코드는 IPv6 주소 체계에서 사용되는 레코드

### CNAME(Canonical Name) 레코드 (별칭 레코드)

- 별칭 이름을 사용할 수 있게 해주는 레코드
- 레코드값에 IP 주소를 매핑하는 A 레코드와 달리 CNAME 레코드는 도메인 주소를 매핑
- 네임 서버가 CNAME 레코드에 대한 질의를 받는다면 CNAME 레코드에 설정된 도메인 정보를 확인하고 도메인 정보를 내부적으로 다시 질의한 결과 IP 값을 응답
- CNAME의 대표적인 예시로 www가 있음
- 예시
	- 만약 example.net이라는 웹사이트에 접속하려 한다면 보통 'example.net'이나 'www.example.net'으로 접속
	- 'example.net'와 'www.example.net'을 각각 A 레코드로 매핑하면 IP 주소가 변경될 때 두 개의 레코드 값을 모두 변경해야 함
	- 'example.net'만 A 레코드로 IP 주소를 매핑하고 'www.example.net'은 CNAME으로서 'example.net'으로 매핑한다면 IP 주소가 변경될 때 'example.net'만 변경해도 동일한 결과값을 가져올 수 있음

### SOA(Start Of Authority) 레코드

- 도메인 영역에 대한 권한을 나타내는 레코드
- 현재 해당 네임 서버가 이 도메인 영역에 대해 관리 주체임을 나타내는 것을 의미
- 도메인 영역 선언 시에 SOA 레코드는 필수 항목이므로 반드시 만들어야 하는 레코드

### NS(Name Server) 레코드

- 도메인에 대한 권한이 있는 네임 서버 정보를 설정하는 레코드
- NS 레코드의 경우 권한이 있는 네임 서버 정보를 해당 도메인에 설정하는 역할 외에도 하위 도메인에 대한 권한을 다른 네임 서버로 위임하는 역할로도 많이 사용됨

### MX(Mail eXchange) 레코드

- 메일 서버를 구성할 때 사용하는 레코드
- 해당 도메인을 메일 주소로 갖는 메일 서버를 MX 레코드를 통하여 선언
- 메일 서버에서 메일을 보낼 때에 MX 레코드를 참조하여 동작하는데 우선순위 값을 이용하여 다수의 MX 레코드를 선언할 수 있음

### PTR(Pointer) 레코드

- A 레코드는 도메인 주소에 대한 질의를 IP로 응답하기 위한 레코드이며, PTR 레코드는 이와 반대로 IP 주소에 대한 질의를 도메인 주소로 응답하기 위한 레코드
	- A 레코드가 정방향 조회용 레코드라면 PTR 레코드는 역방향 조회용 레코드
- A 레코드와는 달리 PTR 레코드는 오직 하나만 가질 수 있음

### TXT(TeXT) 레코드

- 도메인에 대한 설명과 같이 간단한 텍스트를 입력할 수 있는 레코드
- 이 레코드를 특정 기능으로 사용할 수 있는데 주로 사용되는 곳은 **화이트 도메인을 위한 SPF 레코드**에서 사용됨

## DNS 공격

- DNS Spoofing
	- 클라이언트가 질의를 할 때 그 질의를 낚아채 먼저 잘못된 정보를 응답하는 공격
	- 나중에 도착한 올바른 정보는 버려지게 되므로 클라이언트는 잘못된 주소로 접속하게 됨
- DNS Poisoning
	- DNS 정보를 잘못된 정보로 직접 바꾸는 방식
	- 서버에게도 해당
