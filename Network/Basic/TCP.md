# TCP

- 응용 계층에서 페이로드를 생성하고 전송 전에 3단계 연결 설정(3-way handshake)을 수행
	- 응용 계층에서 생성한 페이로드를 응용 계층 버퍼에 임시로 저장하고 전송 계층에서 SYN 신호를 담은 세그먼트를 1개 생성 
	- SYN 세그먼트는 네트워크 계층, 데이터링크 계층, 물리 계층을 통과해서 수신지로 전달
	- 수신측에서는 해당 SYN 신호를 전송 계층까지 끌어올린 후 전송 계층에서 SYN/ACK 신호를 담은 세그먼트를 생성해서 송신지로 전달 
	- 송신측에서는 해당 SYN/ACK 신호를 전송 계층까지 끌어올린 후 전송 계층에서 ACK 신호를 담은 세그먼트를 생성해서 수신지로 전달해서 3단계 연결 설정을 완료
- 3단계 연결 설정이 완료되면 운영체제는 응용 계층 버퍼에 저장했던 TCP 페이로드를 전송 계층으로 전달
- 전송 계층은 응용 계층에서 전달된 TCP 페이로드를 대상으로 **단편화(Fragmentation)** 를 수행
	- 전송 효율성과 데이터 기밀성을 위해 TCP 페이로드를 여러 개로 분할하는 기법
- 단편화가 끝나면 조각난 페이로드 앞에 출발지 포트와 목적지 포트 등을 담은 헤더를 붙여 세그먼트를 생성하고, 각 세그먼트는 네트워크 계층으로 넘어가서 패킷을 생성

## TCP Header

![tcp1](https://github.com/seungwonbased/TIL/blob/main/Network/assets/tcp1.png)

- TCP 헤더의 크기는 가변적
- **일련번호 (Sequence Number)**
	- **전송하는 데이터의 순서**를 의미 → 수신측에서 쪼개진 세그먼트의 순서를 파악해서 재조립할 수 있도록 제공
	- 최초로 데이터를 전송할 때는 랜덤한 수로 초기화하고, 이후에는 자신이 보낼 데이터의 1바이트 당 일련번호를 1씩 증가시켜서 데이터의 순서를 표현
- **확인 또는 승인 번호 (Acknowledgement Number)**
	- **수신자가 예상하는 다음 일련번호 → 다음에 보내줘야 하는 데이터의 시작점**
	- 연결 설정과 연결 해제 때 발생하는 핸드쉐이킹 과정에서는 상대방이 보낸 일련번호 + 1을 확인 번호로 설정
	- 실제 데이터를 주고 받을 때는 상대방이 보낸 일련번호 + 자신 받은 데이터의 바이트 수를 확인 번호로 설정
- 오프셋 (Offset)
	- 전체 세그먼트에서 헤더가 아닌 데이터가 시작되는 위치를 표시
- **TCP 플래그 (Flag)**
	- 현재 세그먼트의 속성
	- CWR (Congestion Window Reduced): 혼잡 윈도우 크기 감소 신호
	- ECN (Explicit Congestion Notification): 혼잡 발생 신호
	- URG (Urgent): 긴급 데이터
	- ACK (Acknowledgement): 확인 응답 신호
	- PSH (Push): 수신측에 데이터를 최대한 빠르게 응용 프로그램에게 전달
	- RST (Reset): 연결을 강제로 리셋해달라는 요청
	- SYN (Synchronize): 연결을 생성
	- FIN (Finish): 연결을 종료
- 윈도우 크기 (Window Size)
	- 슬라이딩 윈도우 (Sliding Window) 크기
	- 한번에 전송할 수 있는 데이터의 크기
- 오류 검사 (Checksum)
	- 데이터 송수신 중에 발생하는 오류를 검출하기 위해 사용
- 긴급 포인트 (Urgent Pointer)
	- URG 플래그가 설정된 경우, 해당 데이터를 우선 처리

### 혼잡 윈도우(Congestion Window, CWND)

- 송신자가 수신자의 확인 응답에 따라 전송할 정보의 양을 조절하는 것 
- 송신자가 수신자에게 1번부터 20번까지 해당 크기의 데이터를 전송하면 해당 데이터를 자신의 버퍼에 저장
	- 송신자 데이터를 버퍼에 저장하는 이유: 전송 중 오류를 대비하기 위해
- 예시
	- 수신자가 해당 데이터 전부를 정상적으로 수신하면 수신자는 윈도우 항목에 21이라는 숫자를 담아 ACK 플래그로 응답
		- 1번부터 20번까지 해당 크기의 데이터를 정상적으로 수신했으므로, 다음에는 21번부터 시작하는 데이터를 보내라는 뜻 
	- 송신자는 버퍼에 저장했던 1번부터 20번까지 데이터를 삭제하고, 21번부터 60번까지에 해당하는 크기의 데이터를 전송하고, 다시 해당 데이터를 자신의 버퍼에 저장
	- 이때 혼잡과 부하 등으로 수신자가 21번부터 40번에 해당하는 크기의 데이터만 수신했다면, 윈도우 항목에 41번을 담아 ACK/CWR 플래그로 응답을 전달
		- CWR 플래그는 송신자에게 전송 데이터를 줄여서 보내라는 의미
	- ACK/CWR 플래그를 수신한 송신자는 전송 직후 자신의 버퍼에 저장했던 데이터 중 41번부터 60번까지에 해당하는 데이터를 재전송
