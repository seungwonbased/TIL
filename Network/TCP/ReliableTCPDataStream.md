# 신뢰성 있는 TCP 데이터 스트림

## TCP를 신뢰성 있게 만드는 것

- Packet loss는 일반적으로 무선 네트워크 간섭이나 네트워크 정체 등의 이유로 데이터가 전송에 실패하여 목적지까지 도달하지 못하는 경우 발생
- Network congestion은 네트워크의 연결 상 처리할 수 있는 양 이상의 데이터를 전송하려 할 때 발생
- TCP는 데이터의 전송 속도를 조정해 네트워크 상태가 변경되더라도 손실된 패킷을 최소로 유지하면서 데이터를 가능한 한 빠르게 전송할 수 있도록 함
  → Flow control
- TCP는 악조건의 네트워크에서 데이터를 잘 전송할 수 없으며 네트워크 하드웨어에 의존적
- TCP는 수신한 패킷을 추적, 승인되지 않은 패킷은 필요에 따라 재전송
  - 전송하는 모든 패킷이 TCP 세션 기간 동안 동일한 경로를 사용한다는 보장 X
  - TCP는 순서 없는 패킷을 정리해 순차적으로 처리

## TCP 세션 사용

- TCP 세션을 사용하면 어떠한 크기의 데이터 스트림이라도 전송할 수 있으며 데이터가 정상적으로 수신되었다는 것을 확인할 수 있음
  - 데이터가 정상적으로 수신되었는지 알기 위해 비효율적으로 필요 이상의 데이터를 네트워크 상에 전송하지 않아도 됨

## TCP 핸드셰이크를 통한 세션 수립

- Three-way handshake라 부르는 과정을 통해 클라이언트와 서버 사이 TCP 연결
- 연결이 정상적으로 이뤄지면 TCP 세션을 생성하며 TCP 세션을 통해 클라이언트와 서버가 데이터를 주고 받음
- TCP 세션이 수립되려면 서버는 반드시 연결 요청을 수신 대기하고 있어야 함
- 이 장에서는 수신 대기 노드와 다이얼링 노드에 대해 각각 Server와 Client라는 용어를 사용

  - 원래 TCP에는 서버와 클라이언트라는 개념이 없음
  - 어떤 한 노드가 다른 노드로 연결한 세션만 존재

- SYN: Synchronization
- ACK: Acknowledgment

### Handshake 단계

![Screenshot 2023-08-16 at 23.28.23.png](https://github.com/seungwonbased/TIL/blob/main/Network/assets/Screenshot_2023-08-16_at_23.28.23.png)

#### 1. 클라이언트가 SYN 플래그가 설정된 패킷을 서버로 전송

- 클라이언트의 정보와 이후 통신에서 사용할 슬라이딩 윈도 설정 값을 알려줌

#### 2. 서버는 ACK 플래그와 SYN 플래그가 설정된 패킷을 클라이언트로 전송

- ACK은 클라이언트의 SYN을 잘 받았다는 의미, SYN 패킷은 클라이언트가 보낸 SYN 패킷의 설정 값에서 어떤 설정 값을 통신 중에 사용할지 클라이언트에 통보

#### 3. 클라이언트는 서버의 SYN 패킷을 승인한다는 ACK 패킷을 보내며 완료

- 이후에 두 노드는 데이터를 주고받을 수 있음

- TCP 세션은 어느 한쪽에서 데이터를 전송하지 않으면 유휴 상태로 남아있음
  - 관리되지 않고 장시간 이런 상태로 남아있으면 메모리 낭비

## 시퀀스 번호를 이용한 패킷 수신 확인

![Screenshot 2023-08-16 at 23.28.41.png](https://github.com/seungwonbased/TIL/blob/main/Network/assets/Screenshot_2023-08-16_at_23.28.41.png)

- 각 TCP 패킷은 Sequence number를 포함하고 있음
  - 시퀀스 번호를 이용해 패킷의 수신을 확인하고 패킷의 순서를 올바르게 정렬 가능

## 수신 버퍼와 슬라이드 윈도 크기

- TCP가 하나 이상 수신된 패킷의 수신 확인을 위해 단 하나의 ACK 패킷을 사용하기 때문에 수신자는 송신자가 수신 확인을 보내기 전에 수신 버퍼에 어느 정도 공간이 가용한지를 미리 전달해야 함
- Receive buffer: 네트워크 연결 중 수신 데이터에서 사용하기 위해 예비해둔 메모리 공간
  - 프로그램 상에서 네트워크에서 데이터를 보내는 즉시 매번 읽을 필요 없이 어느 정도는 데이터를 받을 수 있음
- 클라이언트와 서버는 각 연결마다 자신만의 고유한 수신 버퍼를 관리

- ACK 패킷에는 특별하게 중요한 윈도 크기 정보가 포함됨
- Window size: 송신자가 수신자에게 수신 확인 필요 없이 전송할 수 있는 바이트의 숫자

  - 윈도 크기가 0이면 수신자의 버퍼가 가득 찼다는 의미

- 클라이언트, 서버 양측 모두 필요한 만큼의 수신 버퍼를 채우기 위해 최선을 다해 각각의 윈도 크기를 관리
- Sliding window: ACK 패킷에 윈도 크기를 받고 데이터를 전송한 후 다음 ACK 패킷에 갱신된 윈도 크기를 보내고 계속해서 추가 데이터를 전송하는 방식

![Screenshot 2023-08-16 at 23.34.34.png](https://github.com/seungwonbased/TIL/blob/main/Network/assets/Screenshot_2023-08-16_at_23.34.34.png)

## TCP 세션의 우아한 종료

- TCP 세션을 우아하게 종료하는 것에도 패킷을 주고받는 절차가 있음
- 양측의 연결 중 한쪽에서 FIN 패킷을 보내며 종료 시퀀스 시작

![Screenshot 2023-08-16 at 23.36.26.png](https://github.com/seungwonbased/TIL/blob/main/Network/assets/Screenshot_2023-08-16_at_23.36.26.png)

- 최대 세그먼트 생명주기는 TCP 세그먼트가 송신자가 데이터를 전송 도중에 버렸는지 아닌지를 판단하는 기준 값

## 덜 우아한 종료 처리

- 모든 연결이 깔끔하게 종료되진 않음
- 종종 TCP 연결을 물고 있는 프로그램이 어떤 이유로 충돌하거나 갑작스럽게 멈춰 버리는 경우가 있음
  - 이런 일이 발생하면 TCP 연결이 갑자기 닫히게 되며 연결이 아직 닫히지 않은 쪽에서 전송된 모든 패킷에 대해 **RST (reset) 초기화 패킷**으로 응답
  - RST 패킷은 송신자에게 수신자 측의 연결이 닫혔으며 더 이상 데이터를 수신할 수 없는 상태임을 알려줌
    - 이러면 송신자가 연결을 닫음
  - 방화벽과 같은 중간 노드는 각 노드의 연결에 RST 패킷을 전송해 효과적으로 소켓을 종료할 수 있음
