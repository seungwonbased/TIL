# VM access and Life cycle

# VM access

- VM 액세스를 위해 인스턴스 생성자는 인스턴스에 관한 전체 루트 권한을 가짐
- `Linux` 인스턴스에서 생성자는 `SSH` 기능을 가지며 Cloud Console을 사용해 다른 사용자에게 SSH 기능을 부여 가능
    - 방화벽이 tcp:22 허용해야 함
- `Windows` 인스턴스에서 생성자는 Cloud Console을 사용해 사용자 이름과 비밀번호 생성 가능
    - 사용자 이름과 비밀번호를 알고 있는 사람은 `RDP` (원격 데스크톱 프로토콜) 클라이언트를 사용해 인스턴스에 연결 가능
    - 방화벽이 tcp:3389 허용해야 함
- 그러나 이전에 다룬 기본 네트워크를 사용한다면 이 규칙을 정의할 필요가 없음

# Life cycle

![vmas](https://github.com/seungwonbased/TIL/blob/main/GoogleCloud/assets/vmas1.png)

- 인스턴스의 속성을 모두 정의하고 ‘create’를 클릭하면 인스턴스가 프로비저닝 단계로 전환

## Provisioning

- CPU, 메모리, 디스크 같은 리소스가 인스턴스용으로 예약되지만 인스턴스 자체는 실행되지 않음

## Staging

- 리소스를 확보하고 인스턴스를 시작할 준비가 됨
- Compute Engine이 IP 주소를 추가하고, 시스템 이미지를 부팅하고, 시스템을 부팅

## Running

- 사전 구성된 시작 스크립트가 실행되어 SSH 또는 RDP 액세스를 사용 설정
- 인스턴스를 재부팅할 필요 없이 동일한 영역의 다른 호스트로 가상 머신을 라이브 마이그레이션 할 수 있음
    - Google Cloud는 VM에 영향을 주지 않으면서도 인프라 보호와 안정화에 필수적인 유지보수를 수행할 수 있음
- 인스턴스가 실행되는 동안 VM을 다른 영역으로 이동하거나, VM 영구 디스크의 스냅샷을 생성하거나, 시스템 이미지를 내보내서나, 메타데이터를 다시 구성할 수 있음

## Stopping

- 일부 작업의 경우 가상 머신을 먼저 중지시켜야 함
    - CPU를 추가하여 머신을 업그레이드하는 작업 등
- 이 상태로 전환되면 사전 구성된 종료 스크립트가 실행되어 인스턴스가 종료 상태로 전환됨

## Terminated

- 이 상태에서 인스턴스를 삭제하거나 인스턴스를 다시 시작해 프로비저닝 상태로 되돌릴 수 있음
- VM을 재설정할 수도 있음
    - 이 작업은 머신의 메모리 콘텐츠를 완전히 삭제하고 가상 머신을 초기 상태로 재설정
        - 재설정을 하게 되면 인스턴스는 실행 중 상태로 유지됨
- VM이 종료되면 메모리와 CPU 리소스의 비용을 지불하지 않음
- 그러나 연결된 디스크와 예약된 IP 주소에는 요금이 부과됨
- 중지된 VM의 이미지는 변경 불가능

## Changing VM state from running

![vmas](https://github.com/seungwonbased/TIL/blob/main/GoogleCloud/assets/vmas2.png)

- 인스턴스를 다시 시작하거나 재부팅, 중지, 삭제하는 경우 종료 프로세스에 90초 정도가 걸림
- 선점형 VM의 경우 인스턴스가 30초 후에 중지되지 않으면 Compute Engine이 ACPI G3 Mechanical Off 신호를 OS에 전송
    - 선점형 VM용 종료 스크립트를 작성할 때 이 점을 명심

# VM의 가용성 정책

- 인스턴스의 기본 유지보수 동작은 라이브 마이그레이션이지만 유지보수 이벤트 동안 인스턴스를 종료하도록 변경 가능
- 비정상 종료나 다른 유지보수 이벤트로 VM이 종료되는 경우 인스턴스는 기본적으로 자동 다시 시작이지만 이 동작도 변경 가능
- 이러한 가용성 정책들은 인스턴스를 생성하는 동안은 물론 인스턴스가 실행 중인 동안에도 구성할 수 있음

# OS 패치 관리

## Windows VM 그룹의 업데이트를 관리하는 방법

- 프리미엄 이미지를 프로비저닝하는 경우 이미지와 관련된 비용 발생
    - 이 비용에는 OS 사용 뿐만 아니라 OS 패치 관리도 포함
- 패치를 효과적으로 관리하면 인프라를 최신으로 유지하고 보안 취약점의 위험을 줄일 수 있지만, 적절한 도구 없이는 패치 작업이 어렵고 많은 인력이 필요할 수 있음
- Google Cloud를 사용해 OS 패치를 쉽게 관리할 수 있음
    - 패치 관리를 사용해 Compute Engine VM 인스턴스 조합에 운영체제 패치를 적용 가능

### OS patch management

- Patch compliance reporting (패치 규정 준수 보고)
    - Windows 및 Linux 배포판에서 VM 인스턴스의 패치 상태에 대한 통계 제공
    - 통계와 함께 VM 인스턴스 관련 권장사항도 볼 수 있음
- Patch deployment (패치 배포)
    - 운영체제 및 소프트웨어 패치 업데이트 프로세스를 자동화
    - 패치 작업은 VM 인스턴스에서 실행되며 적용

### 패치 작업과 함께 수행할 수 있는 몇 가지 작업

- 패치 승인
    - 특정 운영체제에 적용되는 전체 업데이트 모음 중에 시스템에 적용할 패치를 선택할 수 있음
- 유연한 예약 설정 가능
    - 패치를 실행할 시기, 일회성 또는 반복 일정 선택 가능
- 고급 패치 구성 설정 적용 가능
    - 패치 전후 스크립트와 같은 구성을 추가해 패치를 맞춤설정 가능
- 중앙 위치에서 패치 작업이나 업데이트 관리 가능