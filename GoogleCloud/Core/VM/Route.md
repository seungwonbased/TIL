# Route and Firewall rules

# Route

- 모든 네트워크에는 `경로`가 포함되어 한 네트워크에 있는 인스턴스 간에 직접 또는 다른 서브넷으로 트래픽을 전송
- 모든 네트워크에는 기본 경로가 있어 네트워크 외부의 대상으로 패킷을 전달
- 기본 경로를 재정의하는 특수 경로를 생성할 수도 있음
- 경로를 만든다고 해서 지정된 다음 홉에 패킷이 수신된다는 보장은 없음

## 경로는 대상 IP 주소별로 패킷을 매핑

![route](https://github.com/seungwonbased/TIL/blob/main/GoogleCloud/assets/route1.png)

- 방화벽 규칙과 일치하지 않으면 트래픽 통과 X
- 네트워크가 생성될 때 경로가 생성되어 어디서나 트래픽 전달 가능
- 서브넷 생성될 때도 경로가 생성됨
- 이를 통해 동일한 네트워크의 VM 간에 통신 가능
- 경로 컬렉션의 각 경로는 하나 이상의 인스턴스에 적용될 수 있음
- 네트워크와 인스턴스 태그가 일치하면 경로가 인스턴스에 적용됨
- 네트워크는 일치하지만 지정된 인스턴스 태그가 없으면 경로가 해당 네트워크의 모든 인스턴스에 적용됨

# Firewall rules

- 방화벽 규칙은 가상 머신 인스턴스를 승인되지 않은 연결에서 보호
- 인그레스 및 이그레스라고 하는 인바운드 및 아웃바운드 연결에 모두 적용됨
- 기본적으로 모든 VPC 네트워크는 분산된 방화벽으로 작동
- 기본 네트워크에는 사전 구성된 방화벽 규칙이 있으며 이를 통해 네트워크의 모든 인스턴스가 서로 통신 가능
- 수동으로 생성된 네트워크에는 이런 규칙이 없으므로 사용자가 직접 생성해야 함
- 방화벽 규칙은 전체 네트워크에 적용되지만 연결은 인스턴스 수준에서 허용되거나 거부됨
    - 방화벽이 인스턴스와 다른 네트워크 사이 뿐만 아니라 동일 네트워크 내 개별 인스턴스 간에도 존재
- 방화벽 규칙은 Stateful
    - 연결이 소스와 대상 간 또는 대상과 목적지 간에 허용되는 경우 두 방향 모두에서 이후의 모든 트래픽이 허용
    - 방화벽 규칙은 세션이 설정되면 양방향 통신을 허용
- 어떤 이유로 네트워크의 모든 방화벽 규칙이 삭제된 경우에도 네트워크에는 묵시적 ‘모두 거부’ 인그레스 규칙과 묵시적 ‘모두 허용’ 이그레스 규칙이 존재
- 원하는 방화벽 구성을 다음 방화벽 규칙 집합으로 표현 가능
    - 규칙 할당은 기본적으로 모든 규칙이 모든 인스턴스에 할당되지만 특정 규칙을 특정 인스턴스에만 할당할 수 있음

![route](https://github.com/seungwonbased/TIL/blob/main/GoogleCloud/assets/route2.png)

## Egress firewall use case

![route](https://github.com/seungwonbased/TIL/blob/main/GoogleCloud/assets/route3.png)

- 이그레스 허용 규칙은 특정 프로토콜, 포트, IP 주소와 일치하는 아웃바운드 연결 허용
- 이그레그 거부 규칙은 허용되지 않은 포트, 프로토콜, IP 범위 조합과 일치하는 연결을 차단
- 이그레스 방화벽 규칙의 경우 IP CIDR 범위를 사용해 규칙 적용 대상을 지정 가능 (왼쪽)
    - 특히 대상 범위를 사용해 VM 인스턴스가 시작한 이우 외부 호스트로의 원치 않은 연결을 차단 가능
- 대상 범위를 사용해 내부 인스턴스에서 특정 CIDR 범위로의 원치 않는 연결 차단 가능 (오른쪽)
    - 특정 서브넷의 VM이 동일한 네트워크에 있는 다른 VM에 부적절한 연결을 시도하는 경우

## Ingress firewall use case

![route](https://github.com/seungwonbased/TIL/blob/main/GoogleCloud/assets/route4.png)

- 인그레스 방화벽 규칙은 모든 소스에서 인스턴스로 수신되는 연결로부터 보호
- 인그레스 허용 규칙은 특정 프로토콜, 포트와 IP 범위의 연결을 허용
- 인그레스 거부 규칙은 허용되지 않는 포트나 프로토콜의 연결 수신을 차단
- 특정 소스에만 영향을 미치도록 규칙을 제한 가능
- 소스 CIDR 범위를 사용해 원치 않는 연결로부터 인스턴스를 보호할 수 있음
    - 이러한 연결은 외부 네트워크 또는 GCP IP 범위에서 수신될 수 있음