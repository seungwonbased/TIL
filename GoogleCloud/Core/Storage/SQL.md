# Cloud SQL

- 완전 관리형, 관계형 데이터베이스 서비스

# 완전 관리형 서비스

- MySQL, PostgreSQL, SQL Server의 완전 관리형 서비스
- 패치와 업데이트가 자동으로 적용됨
    - 기본 인증 도구를 사용해 SQL 사용자를 관리해야 하긴 함
- Compute Engine에 직접 SQL 서버 애플리케이션 이미지를 설치해서 쓰면 관리형 서비스 제공 안됨
    - 자체 구축형 데이터베이스
- Cloud SQL은 다양한 클라이언트 지원
    - Cloud Shell, App Engine, Google Workspace 스크립트
    - 표준 MySQL 드라이버를 사용하는 SQL Workbench와 Toad는 물론 기타 외부 애플리케이션과 같이 익숙한 다른 애플리케이션과 도구도 지원

# Cloud SQL instance

## Perfomance

- 인스턴스당 최대
    - 30TB of storage
    - 40,000 IOPS
    - 416GB of RAM

## 높은 확장성 제공

- 최대 64개 프로세서 코어까지 수직 확장
- 읽기 복제본으로 수평 확장

# Cloud SQL Service

## HA 구성

- 리전 인스턴스 내에서 구성은 기본 인스턴스와 대기 인스턴스로 이뤄짐
- 각 영역의 영구 디스크에 동기식으로 복제하는 기능을 통해 기본 인스턴스에 대한 모든 쓰기 작업은 트랜잭션이 커밋된 것으로 보고되기 전에 양쪽 영역의 디스크에 모두 복제
- 인스턴스 또는 영역에 장애가 발생하면 영구 디스크가 대기 인스턴스에 연결되고 이것이 새 기본 인스턴스가 됨
- 그런 다음 사용자는 새 기본 인스턴스로 다시 라우팅됨
    
    → 이 절차를 장애 조치라고 함 (Failover)
    

## Backup service

- PITR(point-in-time recovery)을 통해 자동화된 주문형 백업을 제공

## Import / Export

- mysqldump를 사용해 데이터베이스를 가져오고 내보내거나 CSV 파일을 가져오고 내보낼 수 있음

## Scailing

- 수직 확장: 머신을 다시 시작하거나
- 수평 확장: 읽기 복제본을 사용해 수평 확장
    - 수평적 확장성에 대해 우려하는 경우 Cloud Spanner를 고려

# 인스턴스에 대한 연결 유형

![sql](https://github.com/seungwonbased/TIL/blob/main/GoogleCloud/assets/sql1.png)

## 비공개 IP 연결

- Cloud SQL 인스턴스와 동일한 Google Cloud 프로젝트 내에서 호스팅되는 애플리케이션을 연결하고 동일한 리전에 배치한 경우 **비공개 IP 연결을 선택하면 비공개 연결을 사용하는 가장 효과적이면서도 안전한 연결이 제공됨**
    - 트래픽이 인터넷에 노출되지 않는다는 뜻
    - 성능에 기초한 권장사항일 뿐이지 요구사항이 아님

## 다른 유형

- 애플리케이션이 다른 리전이나 다른 프로젝트에서 호스팅되거나 Google Cloud 외부에서 Cloud SQL 인스턴스에 연결하려는 경우 세 가지 옵션이 있음
    1. **Cloud SQL Proxy (권장)**
        - 인증, 암호화 및 키 순환을 알아서 처리
    2. SSL 연결을 수동으로 제어해야 한다면 인증서를 직접 생성하고 주기적으로 순환할 수 있음
    3. 외부 IP 주소를 통해 SQL 서버에 연결할 특정 IP 주소를 승인해 암호화되지 않은 연결을 사용할 수 있음

# 스토리지 서비스 결정 트리

![sql](https://github.com/seungwonbased/TIL/blob/main/GoogleCloud/assets/sql2.png)

- 완전 관계형 기능을 갖춘 데이터 스토리지가 필요하지 않은 경우에는 NoSQL을 고려
- 30TB 이상의 스토리지가 필요하거나 데이터베이스에 대한 4,000개 이상의 동시 연결이 필요하거나 글로벌 단위로 수직 확장할 때 애플리케이션 설계가 확장성, 가용성 및 위치 관리를 책임지게 하려는 경우에는 이 모듈의 뒷부분에서 설명하게 될 Cloud Spanner를 고려
- 이러한 제약 조건이 문제가 되지 않으면 특정 OS 요구사항, 커스텀 데이터베이스 구성 요구사항 또는 특별한 백업 요구사항이 있는지 자문
    - 그러한 경우 Compute Engine을 사용해 VM에서 자체 데이터베이스를 호스팅하는 것이 좋음
- 그렇지 않으면 관계형 데이터베이스의 완전 관리형 서비스로 Cloud SQL을 사용하는 것이 좋음

<aside>
💡 Proxy: 프록시는 일반적으로 인터넷을 통한 접근을 제어하기 위해 사용, 클라이언트는 프록시 서버를 경유하여 인터넷에 접근하고, 서버는 프록시 서버를 통해 클라이언트에게 응답, 이를 통해 클라이언트와 서버 간 직접적인 통신을 차단하거나, 보안성을 높일 수 있음

</aside>