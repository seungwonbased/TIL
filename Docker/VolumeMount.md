# Volumes

> Volume은 도커에 의해서만 관리되는 것

- Volume을 지정하면 도커가 일부 폴더와 경로를 호스트 머신에 설정
- Volume에는 두 가지 타입이 있음
- Volume에 액세스할 수 있는 유일한 방법은 **docker volume 명령어**
	- 파일 시스템을 뒤져서 찾을 수는 있지만, 그렇게 작업하면 안 됨
	- Docker가 아닌 프로세스가 파일을 수정하면 안 됨
- **Volume을 사용하는 목적은 컨테이너 간의 데이터 공유**
	- **⚠️ : 호스트와 컨테이너 간의 데이터 공유가 아님!**
        - 호스트와 컨테이너 간의 데이터 공유는 Bind mount로

## Two Types of Volume

### Anonymous Volumes

- Dockerfile에서 VOLUME 명령어로 지정하거나, docker run -v [공유하고자 하는 컨테이너의 경로]로 지정
- 컨테이너가 존재하는 동안에만 존재
	- 로컬 시스템 어딘가에 매핑된 디렉터리가 있음
- Binding Mount를 할 때 덮어씌워지면 안되는 디렉터리를 익명 Volume으로 매핑하여 덮어씌워지지 않도록 할 수 있음

### Named Volumes

- docker run 할 때 -v, --volume 옵션으로 지정
	- docker run -v [볼륨 이름 지정:공유하고자 하는 컨테이너의 경로]
- 컨테이너가 종료된 후에도 볼륨이 유지됨
- 영구적이어야 하는 데이터나, 편집하거나 직접 볼 필요 없는 중요한 데이터에 적합
- 컨테이너를 종료해도 docker volume 하면 그대로 데이터가 남아있는 것을 확인할 수 있음
- 다시 새 컨테이너를 시작하고, -v 옵션으로 볼륨을 연결하면 그대로 이전 데이터 사용 가능

# Binding Mounts

> Binding Mounts는 사용자에 의해서 관리되는 것

- -v, --volume 또는 --mount 옵션으로 지정
	- docker run -v [마운트할 호스트의 절대 경로:마운트할 컨테이너의 경로]
		- 콜론 앞에 로컬 호스트의 머신 경로가 붙으면 Binding Mount, 경로가 아닌 이름이 붙으면 Named Volume으로 취급됨
- 로컬 머신의 실시간 변경분이 컨테이너에 반영됨
	- 웹 서버의 경우, 컨테이너를 재시작해야 변경분이 런타임에 반영되는 경우가 있을 수 있음
- 도커는 기본적으로 호스트 디렉터리를 덮어쓰지 않고 마운트할 컨테이너의 디렉터리를 덮어씀
	- 이로 인해 충돌이 생기면 도커는 더 긴 '내부' 경로를 우선함
		- 도커가 더 길고 구체적인 컨테이너의 경로를 채택하는 것
	- 예시
		- docker run -v $(pwd):/app
		- 하지만 컨테이너의 /app에는 애플리케이션 소스 코드가 빌드되어 있어 로컬 머신의 경로가 이를 덮어써버림
		- /app/modules라는 빌드 시에 생성되어 덮어씌워지면 안되는 디렉터리가 있다고 하면,
			- docker run -v $(pwd):/app -v /app/modules 와 같이 익명 볼륨으로 매핑
		- 도커는 더 길고 구체적인 /app/modules 경로를 채택해 로컬 머신의 경로에 있는 내용을 /app/modules에는 덮어씌워지지 않도록 함

# Quick Overview
## docker run -v 옵션을 사용하는 세 가지 방식
### 1. docker run -v /app/data ...

- Anonymous Volume (익명 볼륨) 생성
- Dockerfile의 VOLUME 명령어로 생성할 수도 있음
- 컨테이너 하나에 연결된 볼륨을 생성
- --rm 옵션으로 컨테이너가 제거되면 볼륨도 제거됨
	- 컨테이너 간에 데이터를 공유할 수 없음
	- 컨테이너의 파괴와 재생성에 걸쳐 데이터를 저장하는 데에 익명 볼륨을 사용할 수 없음
- 컨테이너에 이미 존재하는 특정 데이터를 잠그는 데 유용
	- 데이터가 다른 모듈에 의해 덮어쓰여지는 것을 방지
- 호스트 머신에 디렉터리를 생성하지만, 컨테이너가 제거되면 디렉터리 또한 제거됨
	- 컨테이너 내부에 모든 데이터를 저장할 필요가 없으며 도커가 이 컨테이너 read-write 레이어 내부의 모든 데이터를 관리할 필요가 없다는 것을 의미
	- 그 대신 특정 데이터를 호스트 머신 파일 시스템에 아웃소싱
	- 이러한 특징이 성능과 효율성에 도움이 됨

### 2. docker run -v \name:/app/data ...

- Named Volume (명명된 볼륨) 생성
- Dockerfile에서 생성할 수 없음
- 컨테이너 여러 개에 연결할 수 있음
- 가장 큰 장점은 제너럴하게 생성된다는 것
	- 특정 컨테이너에 종속되지 않음
	- 컨테이너를 종료하고, 제거해도 살아있음
- 제거하려면 도커 CLI에 내장된 명령으로 해야함
- 컨테이너 종료 및 제거 전반에 걸쳐 데이터를 저장하는 데 사용할 수 있음 (컨테이너 데이터의 영구적 저장)

### 3. docker run -v /path/to/code:/app/data ...

- Binding Mount
- 호스트 머신에 데이터가 저장되는 곳을 알고 있기 때문에 컨테이너와 실시간 데이터 공유 가능
- 컨테이너 여러 개에 연결할 수 있음
	- 컨테이너 간 공유 가능
- 컨테이너 종료 및 제거 후에도 유지됨
- 바인드 마운트의 데이터를 지우려면 실제 호스트 머신에서 삭제해야 함
	- 도커 명령으로 삭제할 수 없음
- 재시작을 하고도 동일한 컨테이너 중 하나에서 재사용할 수 있음
