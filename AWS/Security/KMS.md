# Amazon KMS (Key Management Service)

- AWS의 키 관리 서비스인 AWS KMS
- AWS 서비스로 암호화한다고 하면 KMS 암호화일 가능성이 큼
- KMS 서비스를 사용하면 AWS에서 암호화 키를 관리
	- 할 일이 줄어드는 아주 좋은 서비스
- 따라서 KMS는 권한 부여를 위해 IAM과 완전히 통합되고 KMS로 암호화한 데이터에 관한 액세스를 더 쉽게 제어하도록 함
- AWS KMS를 사용의 장점
	- CloudTrail을 통해 키를 사용하기 위해 호출한 모든 API를 감사할 수 있다는 점
	- 이 부분은 시험에도 출제됨
	- 그래서 대부분의 AWS 서비스에 KMS를 원활하게 사용할 수 있음
- 예를 들어, 저장 데이터를 EBS 볼륨에서 암호화하려면 KMS 통합을 활성화하면 됨
	- S3, RDS, SSM에서도 동일하며 암호화가 필요한 거의 모든 서비스에서 동일
	- KMS을 직접 적용할 수도 있음
- **암호 데이터는 절대로 평문으로 저장하면 안 됨**
	- 그냥 하지 마
	- 특히 코드에는 남기면 안됨
- KMS를 사용하기 위해 API 호출을 해도 됨
- AWS CLI나 SDK도 사용 가능한데, 이는 KMS 키를 사용해서 어떤 파일이든 필요하면 암호화할 수 있다는 것
- 그리고 이렇게 암호화된 파일은 코드나 환경변수에 저장되며 이렇게 하는 게 훨씬 좋은 패턴

## KMS Key Types

- 사용 가능한 KMS 키 2가지 유형
- 대칭 KMS 키
	- 데이터 암호화와 복호화에 사용하는 단일 암호화 키만 있어서 KMS와 통합된 모든 AWS 서비스는 대칭 키를 사용
	- KMS 대칭 키를 생성하거나 사용하면 키 자체에는 절대로 액세스할 수 없고 키를 활용 또는 사용하려면 KMS API를 호출해야 함
- 비대칭 키
	- 2개의 키를 의미
	- 데이터 암호화에 사용하는 퍼블릭 키와 데이터 복호화에 사용하는 프라이빗 키
	- 따라서 암호화, 복호화와 작업 할당 및 검증에 사용
	- 이 경우에는 KMS에서 퍼블릭 키를 다운로드 할 수 있지만 프라이빗 키에는 액세스할 수 없음
		- 프라이빗 키에 액세스하려면 API 호출로만 가능
	- 비대칭 키의 사용 사례로
		- KMS API 키에 액세스할 수 없는 사용자가 AWS 클라우드 외부에서 암호화할 때 사용하는 사례가 있음
			- 퍼블릭 키로 데이터를 암호화하고 다시 보내면 계정에서 AWS 프라이빗 키로 해당 데이터를 복호화하는 것
- AWS 관리형 키
	- 예를 들어 aws/rds나 aws/ebs와 같이 이름이 지정됨
	- 무료로 사용할 수 있으며 AWS 서비스와 훌륭하게 통합되어 있으며 무료 서비스이므로 AWS에서 관리하며 특정 서비스에 관한 저장 데이터 암호화에 사용할 수 있음
- 고객 관리형 키
	- CMK
	- KMS를 사용해 생성 가능하고 키 하나에 매달 1달러의 비용이 듬
- 자체 키 
	- 키 구성 요소를 KMS에 가져올 수 있음
	- KMS에서 생성할 수 있고 동일하게 매달 1달러의 비용이 듬
	- 더불어, KMS로 호출하는 모든 API도 비용을 지불해야 함
		- API 호출 10,000건당 약 3센트입니다
- 보안을 위해서 자동으로 키를 교체하도록 설정할 수 있음
	- AWS 자동 관리형 키를 사용하면 자동으로 1년에 한 번씩 교체되며 고객 관리형 KMS 키를 사용하면 반드시 교체되도록 활성화해야 함
	- 활성화한 후에는 자동으로 1년에 한 번씩 교체되며 교체 빈도를 변경할 수는 없음
	- 자체 키 구성 요소를 KMS로 보내려면 수동으로만 키를 교체할 수 있고 올바르게 키를 교체하려면 반드시 KMS 키 별칭을 사용해야 함

## Copying Snapshots Across Regions

![kms](https://github.com/seungwonbased/TIL/blob/main/AWS/assets/kms1.png)

- KMS는 리전에 따라 범위가 지정됨
- 이는 KMS 키로 암호화된 EBS 볼륨이 있고 리전은 eu-west-2라고 할 때 다른 리전으로 복사하려면 몇 가지 단계를 거쳐야 함을 의미
- 먼저, EBS 볼륨의 스냅샷을 생성해야 함
	- 암호화된 스냅샷에서 스냅샷을 생성하면 생성된 스냅샷 또한 동일한 KMS 키로 암호화됨
	- 이제 다른 리전으로 스냅샷을 복사하려면 다른 KMS 키를 사용해서 스냅샷을 다시 암호화해야 하는데 이 부분은 AWS에서 자동으로 처리
		- 다만 동일한 KMS 키가 서로 다른 리전에 있을 수는 없음
	- 이제 EBS 스냅샷을 생성함
		- 다른 KSM 키를 사용해 암호화됐고 다른 리전에 있음
	- 이제 KMS로 스냅샷을 자체 EBS 볼륨으로 복원하고 KMS Key B를 ap-southeast-2로 복원

## KMS Key Policies

- KMS 키에 관한 액세스를 제어하는 것으로 S3 버킷 정책과 비슷하지만 차이점이 있는데, KMS 키에 KMS 키 정책이 없으면 누구도 액세스할 수 없다는 것
- 이와 관련해 2가지 유형의 KMS 키 정책이 있음
- 기본 정책
	- 사용자 지정 키 정책을 제공하지 않으면 생성됨
	- 기본적으로 계정의 모든 사람이 키에 액세스하도록 허용하는 것
	- 즉, 사용자 또는 키 정책의 액세스를 허용하는 IAM 정책이 있으면 되는 것
- 사용자 지정 키 정책
	- 하지만 제어를 조금 더 특정하고자 한다면 KMS 키에 액세스할 수 있는 사용자 또는 역할을 정의하고 키 관리자를 정의할 수 있는 사용자 지정 키 정책을 사용하면 됨
	- KMS 키에 관한 교차 계정 액세스 시 매우 유용
		- 다른 계정이 KMS 키를 사용하도록 권한을 부여하기 때문
	- 언제 사용?
		- 예를 들어, 계정 간에 스냅샷을 복사할 때 사용
			- 자체 KMS 키로 암호화한 스냅샷을 생성하면 고객 키 정책을 연결해야 하므로 고객 관리형 키가 되며 교차 계정 액세스 권한 부여를 위해 KMS 키 정책을 연결
			- 암호화된 스냅샷을 대상 계정에 공유하면 대상 계정에서는 스냅샷 복제본을 생성하고 해당 대상 계정에서 다른 고객 관리형 키로 암호화
			- 이렇게 대상 계정의 스냅샷에서 볼륨을 생성하면 끝
