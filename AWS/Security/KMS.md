# Amazon KMS (Key Management Service)

- AWS의 키 관리 서비스인 AWS KMS
- AWS 서비스로 암호화한다고 하면 KMS 암호화일 가능성이 큼
- KMS 서비스를 사용하면 AWS에서 암호화 키를 관리
	- 할 일이 줄어드는 아주 좋은 서비스
- 따라서 KMS는 권한 부여를 위해 IAM과 완전히 통합되고 KMS로 암호화한 데이터에 관한 액세스를 더 쉽게 제어하도록 함
- AWS KMS를 사용의 장점
	- CloudTrail을 통해 키를 사용하기 위해 호출한 모든 API를 감사할 수 있다는 점
	- 이 부분은 시험에도 출제됨
	- 그래서 대부분의 AWS 서비스에 KMS를 원활하게 사용할 수 있음
- 예를 들어, 저장 데이터를 EBS 볼륨에서 암호화하려면 KMS 통합을 활성화하면 됨
	- S3, RDS, SSM에서도 동일하며 암호화가 필요한 거의 모든 서비스에서 동일
	- KMS을 직접 적용할 수도 있음
- **암호 데이터는 절대로 평문으로 저장하면 안 됨**
	- 그냥 하지 마
	- 특히 코드에는 남기면 안됨
- KMS를 사용하기 위해 API 호출을 해도 됨
- AWS CLI나 SDK도 사용 가능한데, 이는 KMS 키를 사용해서 어떤 파일이든 필요하면 암호화할 수 있다는 것
- 그리고 이렇게 암호화된 파일은 코드나 환경변수에 저장되며 이렇게 하는 게 훨씬 좋은 패턴

## KMS Key Types

- 사용 가능한 KMS 키 2가지 유형
- 대칭 KMS 키
	- 데이터 암호화와 복호화에 사용하는 단일 암호화 키만 있어서 KMS와 통합된 모든 AWS 서비스는 대칭 키를 사용
	- KMS 대칭 키를 생성하거나 사용하면 키 자체에는 절대로 액세스할 수 없고 키를 활용 또는 사용하려면 KMS API를 호출해야 함
- 비대칭 키
	- 2개의 키를 의미
	- 데이터 암호화에 사용하는 퍼블릭 키와 데이터 복호화에 사용하는 프라이빗 키
	- 따라서 암호화, 복호화와 작업 할당 및 검증에 사용
	- 이 경우에는 KMS에서 퍼블릭 키를 다운로드 할 수 있지만 프라이빗 키에는 액세스할 수 없음
		- 프라이빗 키에 액세스하려면 API 호출로만 가능
	- 비대칭 키의 사용 사례로
		- KMS API 키에 액세스할 수 없는 사용자가 AWS 클라우드 외부에서 암호화할 때 사용하는 사례가 있음
			- 퍼블릭 키로 데이터를 암호화하고 다시 보내면 계정에서 AWS 프라이빗 키로 해당 데이터를 복호화하는 것
- AWS 관리형 키
	- 예를 들어 aws/rds나 aws/ebs와 같이 이름이 지정됨
	- 무료로 사용할 수 있으며 AWS 서비스와 훌륭하게 통합되어 있으며 무료 서비스이므로 AWS에서 관리하며 특정 서비스에 관한 저장 데이터 암호화에 사용할 수 있음
- 고객 관리형 키
	- CMK
	- KMS를 사용해 생성 가능하고 키 하나에 매달 1달러의 비용이 듬
- 자체 키 
	- 키 구성 요소를 KMS에 가져올 수 있음
	- KMS에서 생성할 수 있고 동일하게 매달 1달러의 비용이 듬
	- 더불어, KMS로 호출하는 모든 API도 비용을 지불해야 함
		- API 호출 10,000건당 약 3센트입니다
- 보안을 위해서 자동으로 키를 교체하도록 설정할 수 있음
	- AWS 자동 관리형 키를 사용하면 자동으로 1년에 한 번씩 교체되며 고객 관리형 KMS 키를 사용하면 반드시 교체되도록 활성화해야 함
	- 활성화한 후에는 자동으로 1년에 한 번씩 교체되며 교체 빈도를 변경할 수는 없음
	- 자체 키 구성 요소를 KMS로 보내려면 수동으로만 키를 교체할 수 있고 올바르게 키를 교체하려면 반드시 KMS 키 별칭을 사용해야 함

## Copying Snapshots Across Regions

![kms](https://github.com/seungwonbased/TIL/blob/main/AWS/assets/kms1.png)

- KMS는 리전에 따라 범위가 지정됨
- 이는 KMS 키로 암호화된 EBS 볼륨이 있고 리전은 eu-west-2라고 할 때 다른 리전으로 복사하려면 몇 가지 단계를 거쳐야 함을 의미
- 먼저, EBS 볼륨의 스냅샷을 생성해야 함
	- 암호화된 스냅샷에서 스냅샷을 생성하면 생성된 스냅샷 또한 동일한 KMS 키로 암호화됨
	- 이제 다른 리전으로 스냅샷을 복사하려면 다른 KMS 키를 사용해서 스냅샷을 다시 암호화해야 하는데 이 부분은 AWS에서 자동으로 처리
		- 다만 동일한 KMS 키가 서로 다른 리전에 있을 수는 없음
	- 이제 EBS 스냅샷을 생성함
		- 다른 KSM 키를 사용해 암호화됐고 다른 리전에 있음
	- 이제 KMS로 스냅샷을 자체 EBS 볼륨으로 복원하고 KMS Key B를 ap-southeast-2로 복원

## KMS Key Policies

- KMS 키에 관한 액세스를 제어하는 것으로 S3 버킷 정책과 비슷하지만 차이점이 있는데, KMS 키에 KMS 키 정책이 없으면 누구도 액세스할 수 없다는 것
- 이와 관련해 2가지 유형의 KMS 키 정책이 있음
- 기본 정책
	- 사용자 지정 키 정책을 제공하지 않으면 생성됨
	- 기본적으로 계정의 모든 사람이 키에 액세스하도록 허용하는 것
	- 즉, 사용자 또는 키 정책의 액세스를 허용하는 IAM 정책이 있으면 되는 것
- 사용자 지정 키 정책
	- 하지만 제어를 조금 더 특정하고자 한다면 KMS 키에 액세스할 수 있는 사용자 또는 역할을 정의하고 키 관리자를 정의할 수 있는 사용자 지정 키 정책을 사용하면 됨
	- KMS 키에 관한 교차 계정 액세스 시 매우 유용
		- 다른 계정이 KMS 키를 사용하도록 권한을 부여하기 때문
	- 언제 사용?
		- 예를 들어, 계정 간에 스냅샷을 복사할 때 사용
			- 자체 KMS 키로 암호화한 스냅샷을 생성하면 고객 키 정책을 연결해야 하므로 고객 관리형 키가 되며 교차 계정 액세스 권한 부여를 위해 KMS 키 정책을 연결
			- 암호화된 스냅샷을 대상 계정에 공유하면 대상 계정에서는 스냅샷 복제본을 생성하고 해당 대상 계정에서 다른 고객 관리형 키로 암호화
			- 이렇게 대상 계정의 스냅샷에서 볼륨을 생성하면 끝

## KMS Multi-Region Keys

![kms](https://github.com/seungwonbased/TIL/blob/main/AWS/assets/kms2.png)

- KMS 다중 리전 키
- AWS KMS에는 다중 리전 키를 둘 수 있음
	- 선택된 한 리전에 기본 키를 갖는다는 의미
- 예를 들면 us-east-1에 기본 키를 두면 다른 리전으로 복제됨
	- us-west-2, eu-west-1 ap-southeast-2로 복제됨
	- 키 구성 요소가 복제됨
- 다른 리전도 동일한 키를 갖게 되는데, 키 ID가 완전히 똑같음
	- key/mrk 뒤에 붙은 문자들이 전체 리전에 걸쳐 동일함
- KMS 다중 리전 키는 다른 AWS 리전에서 사용할 수 있는 KMS 키 세트로 서로 교차해서 사용할 수 있음
	- 한 리전에서 암호화한 다음 다른 리전에서 복호화 할 수 있음
- 다중 리전 키는 동일한 키 ID와 동일한 키 구성 요소를 가짐
- 기본 키의 자동 교체를 활성화했고 실제로 자동으로 교체된 키는 다른 리전에도 복제됨
- 다중 리전 키의 핵심은 한 리전에서 암호화하고 다른 리전에서 복호화해 다음 리전으로 복제할 때나 교차 리전 API 호출을 실행할 때 데이터를 재암호화하지 않아도 된다는 점
- 하지만 KMS 다중 리전 키는 전역으로 사용할 수 없다는 점을 기억
	- 기본 키가 있고 복제본이 있는 것
- 각 다중 리전 키는 자체 키 정책 등으로 각각 독립적으로 관리됨
- 따라서 특정 사용 사례를 제외하고는 다중 리전 키 사용을 권장하지 않음
- KMS 키는 단일 리전에 제한되는 것을 선호하기 때문
- 다중 리전 키의 사용 사례
	- 전역 클라이언트 측 암호화
		- 한 리전에서 클라이언트 측 암호화를 하고 다른 리전에서 클라이언트 측 복호화를 하는 것
	- DynamoDB 전역 테이블이나 Global Aurora에서 암호화하는 데도 사용됨

### DynamoDB Global Tables and KMS Multi- Region Keys Client-Side Encryption

![kms](https://github.com/seungwonbased/TIL/blob/main/AWS/assets/kms3.png)

- DynamoDB 전역 테이블과 KMS 다중 리전 키를 클라이언트 측 암호화하는 원리
- 중요한 것은 전체 테이블만 암호화하는 게 아니라는 점
- 저장 데이터 암호화이므로 테이블의 속성을 암호화하여 특정 클라이언트만 사용할 수 있게됨
	- 데이터베이스 관리자도 사용할 수 없음
- 이때 Amazon DynamoDB 암호화 클라이언트를 사용
- us-east-1과 ap-southeast-2를 예로 들어 설명
	- us-east-1의 KMS 다중 리전 키는 다른 리전에 복제됨
		- ap-southeast-2
	- 클라이언트 애플리케이션에서 DynamoDB에 데이터를 삽입하려면 먼저 속성을 암호화해야 함
	- 다중 리전 키를 사용해 암호화할 속성을 암호화
	- 대부분의 DynamoDB 테이블 필드는 클라이언트 측 암호화가 되지 않지만 가령 사회 보장 번호는 암호화될 것
	- DynamoDB 테이블에 액세스할 수 있는 데이터베이스 관리자가 '사회 보장 번호' 속성을 암호화하는 데 사용한 KMS 키에 액세스할 수 있는 권한이 없다면 액세스할 수 없음
		- 데이터베이스 관리자로부터도 보호할 수 있는 것
	- DynamoDB 테이블이 전역 테이블인 경우 해당 테이블의 데이터는 다른 리전으로 복제됨
		- ap-southeast-2로 복제됨
	- 다행히 다중 리전 키로 데이터 속성을 암호화하기로 했기 때문에 ap-southeast-2 리전의 클라이언트 애플리케이션은 열을 검색해서 해당 속성이 암호화됐는지 확인한 후 API 호출을 실행해 복제된 다중 리전 키를 사용해 해당 속성을 복호화
		- ap-southeast-2의 클라이언트 애플리케이션이 KMS로 로컬 API 호출을 보내 해당 속성을 복호화하는 것
- 클라이언트 측 암호화 기술을 사용하면 데이터의 특정 필드나 속성을 보호할 수 있음
	- API 키 액세스 권한이 있는 클라이언트만 복호화할 수 있음
- 또한 전역 테이블 덕분에 데이터뿐만 아니라 암호화 키도 함께 복제할 수 있음
- Global Aurora의 개념도 유사
	- AWS Encryption SDK를 사용
	- 두 개의 리전이 있고 두 리전에 걸쳐 복제된 KMS 다중 리전 키가 있음
	- 클라이언트 애플리케이션이 SSN 열을 암호화하려면 데이터를 Amazon Aurora DB에 테이블로 삽입해야 함
	- 해당 행에서 다중 리전 키인 MRK로 암호화된 SSN 열을 제외한 다른 열의 데이터는 암호화되지 않음
	- 전역 데이터베이스이므로 테이블이 전역으로 복제될 것
		- 따라서 ap-southeast-2에도 동일한 데이터가 생김
	- ap-southeast-2의 클라이언트는 테이블에서 암호화된 데이터를 가져오고 다중 리전 키를 사용해 KMS에 로컬 API 호출을 보내 해당 속성을 복호화
		- 따라서 지연 시간이 단축됨
	- 클라이언트 측 암호화를 사용하면 DB 관리자로부터도 데이터를 보호할 수 있음
	- Amazon Aurora DB에 액세스할 수 있는 DB 관리자가 '사회 보장 번호' 열에 액세스하고자 할 때 KMS 키에 대한 액세스 권한이 없으면 해당 데이터를 읽을 수 없음
	- 아주 유용

## S3 Replication Encryption Considerations

- S3 복제와 암호화된 객체의 연관성
- 한 버킷에서 다른 버킷으로 S3 복제를 활성화하면 암호화되지 않은 객체와 SSE-S3로 암호화된 객체가 기본으로 복제됨
- 고객 제공 키인 SSE-C로 객체를 암호화하면 복제되지 않음
	- 항상 키를 제공해야 하는데 그럴 수 없기 때문
- SSE-KMS로 암호화된 객체도 있음
- 기본적으로 복제되지 않지만 만약 객체를 복제하려면 옵션을 활성화해야 함
	- 따라서 어떤 KMS 키로 대상 버킷 내 객체를 암호화하는지 지정해야 함
- 그리고 이 KMS 키 정책을 대상 키에 적용해야 하고 S3 복제 서비스를 허용하는 IAM 역할을 생성해서 소스 버킷의 데이터를 먼저 복호화하도록 한 뒤 대상 KMS 키로 대상 버킷의 데이터를 다시 암호화
- 이렇게 하면 복제가 활성화되는데, 이는 수많은 암호화와 복호화가 발생하기 때문
- KMS 스로틀링 오류가 발생한 경우는 서비스 할당량을 요청해야 함
- 공식 문서에 따르면 S3 복제에 다중 리전 키를 사용할 수 있으나 현재는 Amazon S3 서비스에서 독립 키로 취급하고 있으므로 객체는 여전히 복호화될 것이고 다중 리전 키인 경우에도 동일한 키로 암호화됨

## AMI Sharing Process Encrypted via KMS

![kms](https://github.com/seungwonbased/TIL/blob/main/AWS/assets/kms4.png)

- 시험에 출제될 문제
- AMI를 다른 계정과 공유하는 과정에 관한 것으로 AMI는 KMS 키로 암호화 되어 있음
- AMI는 소스 계정에 있고 KMS 키로 암호화된 것
- 어떤 방식으로 A 계정의 AMI에서 B 계정의 EC2 인스턴스를 시작하는지?
	- 먼저, 시작 권한으로 AMI 속성을 수정해야 하는데 이 시작 권한은 B 계정에서 AMI를 시작하도록 허용
		- 이렇게 AMI를 공유
		- 시작 권한을 수정하고 특정 대상인 AWS 계정 ID를 추가하는 것
	- 그런 다음 B 계정에서 사용하도록 KMS 키도 공유해야 하므로 일반적으로 키 정책으로 실행됨
	- 이제 B 계정에서 KMS 키와 AMI를 모두 사용할 수 있는 충분한 권한을 가진 IAM 역할이나 IAM 사용자를 생성
		- 따라서 DescribeKey API 호출과 ReEncrypted API 호출, CreateGrant, Decrypt API 호출에 관한 KMS 측 액세스 권한이 있어야 함
	- 모두 완료된 후에는 AMI에서 EC2 인스턴스를 시작하면 되는데 선택 사항으로 대상 계정에서 자체 계정의 볼륨을 재암호화하는 KMS 키를 이용해 전체를 재암호화할 수 있음
	- 이제 EC2 인스턴스를 실행할 수 있음
