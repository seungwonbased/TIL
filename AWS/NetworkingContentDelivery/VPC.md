# CIDR, Public vs Private IP
## Understanding CIDR - IPv4

![vpc](https://github.com/seungwonbased/TIL/blob/main/AWS/assets/vpc1.png)

- CIDR 또는 사이더라고 불리는 클래스 없는 도메인 간 라우팅
- IP 주소를 할당하는 방법
- 예시에 있는 보안 그룹 규칙의 소스 열을 보면 IP 주소/숫자가 나와있음
	- 즉 CIDR는 단순한 IP 범위를 정의하는 데 도움을 줌
- /32로 끝나는 IP 주소는 사실 IP 하나만 나타냄
- 0.0.0.0/0이라면 모든 IP를 나타냄
- 192.168.0.0/26는 IP 주소 64개를 나타냄
- CIDR의 두 가지 구성 요소
	- 기본 IP
		- 범위에 포함된 IP
		- 일반적으로는 범위의 시작이 되는데 범위 내부에 있기도 함
		- 예시로 10.0.0.0 또는 192.168.0.0 등이 있음
	- 서브넷 마스크
		- IP에서 변경 가능한 비트의 개수를 정의
		- 여기에는 /0, /24 그리고 /32까지 있는데
- 두 가지 형식
	- 예를 들면 /8은 서브넷 마스크 255.0.0.0과 동일
		- /16은 255.255.0.0과 같음
	- 가장 많이 보이는 형식은 / 형식

## Understanding CIDR - Subnet Mask

![vpc](https://github.com/seungwonbased/TIL/blob/main/AWS/assets/vpc2.png)

- 기본 IP에서 변경할 수 있는 값 정의하는 방법
	- "IP 주소/32"는 2의 0승으로 IP 하나만 허용
	- "IP 주소/31"이라면 두 가지 IP가 허용됨
	- "IP 주소/30"의 경우 기하급수적으로 증가하는데 IP 네 개가 허용됨
	- "IP 주소/29"는 IP 여덟 개를 허용
	- "IP 주소/0"은 모든 IP를 허용
- IP는 옥텟 네 개로 구성됨
	- 총 네 가지 부분으로 이루어짐
	- /32는 옥텟 변경 불가를 뜻하고, /24는 마지막 옥텟 변경 가능, /16은 마지막 옥텟 두 개가 변경되고 다른 값을 가짐, /8은 마지막 옥텟 세 개가 바뀌고 /0은 옥텟 전체가 변경됨

## Public vs Private IP (IPv4)

- IANA(Internet Assigned Numbers Authority)에서 구축한 특정 IPv4 주소 블록은 사설 LAN 네트워크 다시 말해 로컬 네트워크나 공용 인터넷 주소
- 사설 IP는 특정 값만 허용
	- 10.0.0.0 – 10.255.255.255 (10.0.0.0/8): 사용 가능한 사설 IP 범위, 대형 네트워크에서 사용
	- 172.16.0.0 – 172.31.255.255 (172.16.0.0/12): AWS default VPC in that range
	- 192.168.0.0 – 192.168.255.255 (192.168.0.0/16): Home Networks

# VPC
## Default VPC Walkthrough

- 계정에 생성되는 VPC인 기본 VPC
	- 새로운 AWS 계정은 모두 기본 VPC가 있고 바로 사용할 수 있음
- 새로운 EC2 인스턴스는 서브셋을 지정하지 않으면 기본 VPC에 실행됨
- 계정을 시작하면 VPC는 하나만 생김
- 기본 VPC는 처음부터 인터넷에 연결돼 있어서 인스턴스가 인터넷에 액세스하고, 또 내부의 EC2 인스턴스는 공용 IPv4 주소를 얻음
	- EC2 인스턴스를 생성하자마자 연결할 수 있는 이유가 바로 이 때문
- 또한 EC2 인스턴스를 위한 공용 및 사설 IPv4 DNS 이름도 얻음

## 실습
## Creating VPC in AWS - IPv4

![vpc](https://github.com/seungwonbased/TIL/blob/main/AWS/assets/vpc3.png)

- Virtual Private Cloud를 줄여 VPC라고 함
- 단일 AWS 리전에 여러 VPC를 둘 수 있음
- 리전당 최대 5개까지 가능한데, 엄격히 제한하지 않아서 늘릴 수 있음
- VPC마다 할당된 CIDR는 다섯 개
	- 각 CIDR의 최소 크기는 /28로 IP 주소는 최소 16개가 있음
		- 최대 크기는 /16으로 IP 주소는 최대 65,536개
- VPC가 사설 리소스이기 때문에 사설 IPv4 범위만 허용됨
	- 10.0.0.0 – 10.255.255.255 (10.0.0.0/8)
	- 172.16.0.0 – 172.31.255.255 (172.16.0.0/12)  
	- 192.168.0.0 – 192.168.255.255 (192.168.0.0/16)
	- VPC에 어떤 범위를 선택해야 하는지?
		- 일반적인 규칙으로는 원하는 대로 할당할 수 있지만, VPC CIDR가 다른 VPC나 네트워크 혹은 기업 네트워크와 겹치지 않도록 주의
		- 함께 연결하려면 VPC 혹은 CIDR IP 주소가 다른 네트워크의 IP 주소 범위와 겹치지 않아야 하기 때문

## Adding Subnets in AWS

![vpc](https://github.com/seungwonbased/TIL/blob/main/AWS/assets/vpc4.png)

- VPC에 서브넷을 추가
- 서브넷을 두 개 만들 건데, 하나는 공용 서브넷이고 다른 하나는 사설 서브넷
- 모두 한 가용 영역에 있음
- 서브넷이란
	- VPC 내부에 있는 IPv4 주소의 부분 범위
	- 이 범위 내에서 AWS가 IP 주소 다섯 개를 예약
		- IP 주소 처음 네 개, 마지막 한 개를 서브넷마다 예약
		- 이런 IP 주소는 사용도 안 되고 EC2 인스턴스에 IP로 할당되지도 못함
		- 예를 들어 CIDR 블록 10.0.0.0/24가 있다면 일부는 예약된 IP 주소
		1. 네트워크 주소
		2. .1은 VPC 라우터용
		3. 10.0.0.2는 Amazon 제공 DNS에 매핑
		4. .3은 당장 사용되진 않지만 나중에 필요할지 모르니까 예약해 둠
		5. 마지막 네트워크 브로드캐스트 주소인 .255는 AWS는 VPC에서 브로드캐스트를 지원하지 않기에 예약은 되지만 사용하는 건 안 됨
		- EC2 인스턴스 서브넷에서 IP 주소 29개가 필요할 때 /27 서브넷은 사용 못 한다는 걸 시험 볼 때 기억
			- /27 IP 주소는 32개인데 예약된 IP 주소 다섯 개를 제외하면 27개만 남기 때문
			- 따라서 서브넷 크기는 /26이어야 함

## Adding an Internet Gateway in AWS

![vpc](https://github.com/seungwonbased/TIL/blob/main/AWS/assets/vpc5.png)

- 서브넷에 인터넷 액세스를 연결하는 방법
- 현재로서는 두 종류의 서브넷에 인터넷 액세스가 없음
- Internet Gateway
	- VPC의 리소스를 인터넷에 연결하도록 허용하는 EC2 인스턴스나 람다 함수 등
	- 수평으로 확장되고 가용성과 중복성이 높음
	- 관리형 리소스
	- VPC와는 별개로 생성해야 하고, VPC는 인터넷 Gateway 하나에만 연결되며 반대의 경우도 마찬가지
	- 인터넷 Gateway 자체는 인터넷 액세스를 허용하지 않음
	- 작동을 위해 라우팅 테이블을 수정해야 함

## Adding Routing Tables

![vpc](https://github.com/seungwonbased/TIL/blob/main/AWS/assets/vpc6.png)

- 공용 서브넷에 공용 EC2 인스턴스를 만들고, 라우팅 테이블을 수정해서 EC2 인스턴스를 라우터에 연결하고 Internet Gateway에 연결
- 그러면 인터넷 Gateway가 인터넷과 연결될 수 있음

## Bastion Hosts

![vpc](https://github.com/seungwonbased/TIL/blob/main/AWS/assets/vpc7.png)

- 사용자가 프라이빗 서브넷에 있는 EC2 인스턴스에 액세스하고자 함
- 사용자는 퍼블릭 인터넷에 있는데, 이는 사용자의 EC2 인스턴스가 프라이빗 서브넷에 위치하지 않기 때문
- 프라이빗 서브넷에 대한 인터넷 액세스는 없음
- 이때 배스천 호스트를 사용할 수 있음
	- 배스천 호스트는 이름 그대로의 EC2 인스턴스인데, 이 EC2 인스턴스는 퍼블릭 서브넷에 있다는 점이 특이점
- 배스천 호스트 보안 그룹이라는 자체 보안 그룹이 있음
	- 물론 프라이빗 서브넷에 있는 EC2 인스턴스에도 보안 그룹이 있음
- 퍼블릭 서브넷에 있는 EC2 인스턴스, 즉 배스천 호스트로 프라이빗 서브넷에 있는 EC2 인스턴스에 액세스할 수 있음
	- 이 모든 것이 VPC에 존재하기 때문
- 프라이빗 서브넷에 있는 EC2 인스턴스에 액세스하려면, 먼저 SSH를 배스천 호스트에 연결하고, 이 배스천 호스트를 다시 SSH를 프라이빗 서브넷의 EC2 인스턴스에 연결해야 함
	- 물론 EC2 인스턴스는 여러 개일 수 있음
- 요약하자면 배스천 호스트를 통해 프라이빗 EC2 인스턴스에 SSH로 액세스할 수 있음
	- 이때 배스천 호스트는 반드시 퍼블릭 서브넷에 있어야 함
- 시험에는 보안 규칙 관련 내용도 출제되는데, 무엇을 정의할 수 있는지 잘 이해해야 함
	- 배스천 호스트를 위해서는 보안 그룹이 반드시 인터넷 액세스를 허용해야 함
	- 하지만 모든 인터넷 액세스를 허용하면 보안상 위험이 크기 때문에, 예를 들면 기업의 퍼블릭 CIDR 액세스만 허용하거나 사용자의 인터넷 액세스만 허용하는 등 이를 제한하는 게 좋음
		- 이렇게 배스천 호스트의 EC2 보안 그룹을 최대한 제한하여 특정 IP만 액세스가 가능하도록 설정할 수 있음
		- 그렇지 않으면 배스천 호스트에 공격자가 액세스하여 EC2 인스턴스를 공격하는 등 인프라에 보안상 위험이 발생할 수 있음
	- 프라이빗 서브넷의 EC2 인스턴스 보안 그룹에서는 반드시 SSH 액세스를 허용해야 함
		- 따라서 포트 22번이 배스천 호스트의 프라이빗 IP가 되거나 배스천 호스트의 보안 그룹이 되는 셈
		- 이는 트래픽, 즉 EC2 인스턴스가 배스천 호스트를 이용하여 연결되기 때문

## 구형 NAT Instance (outdated, but still at the exam)

![vpc](https://github.com/seungwonbased/TIL/blob/main/AWS/assets/vpc8.png)

- 더 좋은 솔루션인 NAT Gateway이 있음
	- 그러나 시험에 나옴
- NAT: Network Address Translation, 네트워크 주소 변환
- NAT 인스턴스는 사설 서브넷 EC2 인스턴스가 인터넷에 연결되도록 허용
- NAT 인스턴스는 공용 서브넷에서 실행되어야 하고, 공용 및 사설 서브넷을 연결
- 비활성화해야 하는 설정은 소스/목적지 확인
- NAT 인스턴스에는 고정된 탄력적 IP가 연결되어야 함
- 예시
	- 서버가 있는데, 공용 서버이며 IP는 50.60.4.10
	- 이때 사설 서브넷에서 액세스를 함
	- 사설 서브넷에서 어떻게 서버로 연결되는지?
		- 공용 서브넷에 고유의 보안 그룹이 있는 NAT 인스턴스를 실행하면 됨
		- 다음은 NAT 인스턴스에 탄력적 IP를 연결
		- 또한 라우팅 테이블을 수정하여 사설 서브넷과 공용 서브넷의 두 서브넷에 있는 EC2 인스턴스로부터 NAT 인스턴스로 트래픽을 전송하도록 함
		- 그리고 인스턴스의 IP는 공용 서버로 액세스하는데 NAT 인스턴스를 통과해야 함
		- 따라서 요청에는 소스 IP가 10.0.0.20, 즉 사설 IP이고 목적지는 50.60.4.10인데 NAT 인스턴스는 트래픽을 다른 곳으로 전송하려는 것을 깨닫고 해당 서버로 트래픽을 보냄
	- 그 서버에는 다른 점이 있음
		- 목적지 IP는 같지만 소스 IP는 12.34.56.78
			- NAT 인스턴스의 공용 IP에 해당
		- 네트워크 패킷이 NAT 인스턴스로 재작성됨
			- 바로 NAT 인스턴스가 하는 일이 네트워크 패킷의 재작성
			- 그래서 소스 IP가 변경됨
	- 이제 서버에서 응답하는데, 소스는 자기 자신이고 목적지는 NAT 인스턴스의 공용 IP가 됨
	- 그러면 NAT 인스턴스가 다시 EC2 인스턴스로 트래픽을 회신
		- 소스는 공용 서버이고 목적지는 사설 IP
	- 이런 이유로 일부의 IP가 재작성되고, 또 NAT 인스턴스를 위해 소스 및 목적지 확인 설정을 EC2 인스턴스에서 비활성화해야 하는 것
- NAT 인스턴스의 작동 방식을 크게 보면 공용 서브넷에 NAT 인스턴스를 생성하고, 거기에 탄력적 IP를 연결
	- 그리고 라우팅 테이블을 통해 사설 인스턴스가 NAT 인스턴스에서 Internet Gateway까지 통신하도록 함
- NAT 인스턴스를 보면, 사전 구성된 Amazon Linux AMI를 사용할 수 있었지만 2020년 12월 31일로 표준 지원이 종료되었기에 이제 NAT Gateway를 권장
	- NAT 인스턴스는 가용성이 높지 않고 초기화 설정으로 복원할 수 없어서 여러 AZ에 ASG를 생성해야 하고, 복원되는 사용자 데이터 스크립트가 필요하기에 복잡
	- 그리고 작은 인스턴스는 큰 인스턴스에 비교해서 대역폭이 더 작음
- 보안 그룹과 규칙을 관리해야 함
	- 인바운드에서는, 사설 서브넷의 HTTP/HTTPS 트래픽을 허용하고 홈 네트워크의 SSH도 허용
	- 아웃바운드에서도 트래픽이 나가도록 함

## Adding an NAT Gateway

![vpc](https://github.com/seungwonbased/TIL/blob/main/AWS/assets/vpc9.png)

- NAT Gateway AWS의 관리형 NAT 인스턴스이며 높은 대역폭을 가지고 있음
	- 가용성이 높으며 관리할 필요가 없음
- 사용량 및 NAT Gateway의 대역폭에 따라 청구됨
- 특정 AZ에서 생성되고 탄력적 IP를 이어받음
- EC2 인스턴스와 같은 서브넷에서 사용할 수 없어서 다른 서브넷에서 액세스할 때만 사용
- 공용 서브넷에서 NAT Gateway를 만들고 사설 서브넷의 인스턴스와 연결
	- 경로는 사설 서브넷에서 NAT Gateway로 다시 인터넷 게이트웨이까지
	- 즉 NAT Gateway에는 인터넷 게이트웨이가 있어야 함
- 대역폭은 초당 5GB이며, 자동으로 초당 45GB까지 확장할 수 있음
- 보안 그룹을 관리할 필요가 없음
	- 연결을 하기 위해서 어떤 포트를 활성화할지 생각할 필요가 없음
- 작동 구조
	- 사설 인스턴스와 서브넷이 있고 인터넷에 액세스가 없는 상태
	- NAT Gateway를 공용 서브넷에 배포
		- NAT Gateway가 공용 서브넷에 있으므로 공용 서브넷은 이미 인터넷 게이트웨이에 연결됐고, NAT Gateway에 인터넷 연결이 생김
	- 다음은 사설 서브넷의 루트를 수정
		- 그렇게 해서 EC2 인스턴스를 NAT Gateway에 연결할 수 있음

### NAT Gateway with High Availability

![vpc](https://github.com/seungwonbased/TIL/blob/main/AWS/assets/vpc10.png)

- 단일 AZ에서 복원 가능
	- 단일 AZ 내에서만 중복됨
- AZ가 중지될 경우를 위해 다중 NAT Gateway를 여러 AZ에 두면 결함 허용을 할 수 있음
- 작동 방식
	- 현재 하나의 NAT Gateway가 하나의 특정 AZ에 있다고 가정
	- 두 번째 AZ에 두 번째로 NAT Gateway를 생성
	- 각 네트워크 트래픽은 AZ 안에 제한됨
		- 따라서 AZ가 중지되면 전체 AZ가 중지됨
	- 그런데 아직 AZ-B가 작동함
		- AZ-B에도 NAT Gateway가 있기 때문
	- 라우팅 테이블을 통해 AZ를 서로 연결할 필요는 없음
	- 만약 AZ가 중지되면 그 AZ의 EC2 인스턴스가 액세스 불가 상태가 됨

### NAT Gateways vs NAT Instance

![vpc](https://github.com/seungwonbased/TIL/blob/main/AWS/assets/vpc11.png)

- NAT Gateway
	- 가용성
		- 특정 AZ에서 가용성이 높음
		- 전체에서 고가용성을 필요로 하는 경우 다른 AZ에 더 만들어야 함
	- 대역폭
		- NAT Gateway마다 초당 최대 45GB
	- 유지 보수
		- NAT Gateway는 관리형 서비스
	- 비용
		- 경우 시간당 비용과 NAT Gateway의 데이터 전송량을 더함
	- IP
		- 공용 IPv4와 사설 IPv4를 가짐
	- 보안 그룹
		- 사용하지 않으므로 관리할 것이 줄어듬
	- Bastion Host
		- Bastion Host로 쓸 수 없음
- NAT Instance
	- 가용성
		- 인스턴스간 장애 조치 스크립트를 통해서 전체적인 관리를 해야 함
	- 대역폭
		- 사용하는 EC2 인스턴스에 따라 다른데, 고급 인스턴스 유형일수록 더 많은 처리량을 가짐
	- 유지 보수
		- 사용자가 하고, OS 패치 등 소프트웨어가 필요
	- 비용
		- 시간당 EC2 인스턴스가 청구되며 EC2 인스턴스 유형과 크기에 따라 달라짐
		- EC2 인스턴스를 통해 인터넷으로 나가는 네트워크 비용도 함께 청구됨
	- IP
		- 공용 IPv4와 사설 IPv4를 가짐
	- 보안 그룹
		- 보안 그룹을 설정해 맞는 포트에 작동하게 해야 함
	- Bastion Host
		- 필요한 경우 Bastion Host로 쓸 수 있음

## Security Groups & NACLs

![vpc](https://github.com/seungwonbased/TIL/blob/main/AWS/assets/vpc12.png)

- 예시: 서브넷에서 언제 보안 그룹이 연결된 EC2 인스턴스를 사용하는지
	- 요청이 EC2 인스턴스 내부로 이동
	- 네트워크 관점에서 우선 요청이 서브넷에 들어가기 전 먼저 NACL로 이동
	- NACL에는 몇 가지의 인바운드 규칙이 정의되며 요청이 허용되지 않으면 내부로 들어갈 수 없음
	- NACL은 무상태
	- 첫 번째 요청이 NACL을 통과해서 서브넷 내부에 도달
	- 그리고 보안 그룹 인바운드 규칙을 만남
		- 만약 그 요청이 명시적으로 허용 받지 못하면 거부될 것
		- 보안 그룹의 특징은 상태 유지
- NACL은 무상태이고 보안 그룹은 상태 유지
	- 만약 요청이 보안 그룹의 인바운드 규칙을 통과해서 EC2 인스턴스에 도달하면 EC2 인스턴스는 그 응답으로 애플리케이션 관점에서 응답할 내용을 모두 회신
	- 아웃바운드 규칙은 자동으로 보안 그룹 수준에서 허용됨
		- 보안 그룹의 특징이 상태 유지이기 때문
		- 다시 말해 들어간 것은 전부 나올 수 있음
- NACL은 상태 없음 즉 무상태
	- 무상태이기 때문에 NACL 아웃바운드의 규칙이 평가됨
	- 규칙이 통과하지 못하면 요청도 통과하지 못할 것임
- 이번에는 보안 그룹에서 EC2 인스턴스가 아웃바운드 요청
	- EC2 인스턴스는 먼저 www.google.com 등에 접속
	- 그리고 처음으로 평가될 규칙은 보안 그룹 아웃바운드 규칙
	- 트래픽이 EC2 인스턴스에서 웹으로 나가도록 허용할지 결정
	- 규칙이 적절하고 요청이 허가되면 요청은 또한 NACL 아웃바운드 규칙을 통과
	- 이런 식으로 평가된 요청이 www.google.com에 도달하고 Amazon 웹 서비스로 다시 돌아오는 것
	- 그리고 NACL이 무상태라서 NACL 인바운드 규칙이 평가될 수 있음
- 보안 그룹 수준에서 서브넷의 인바운드 규칙은 무조건 허용됨
	- 보안 그룹 규칙의 상태 유지 특징 때문

## NACL

![](https://i.imgur.com/cL3uQOE.png)

- 네트워크 액세스 제어 목록
- 서브넷을 오가는 트래픽을 제어하는 방화벽과 비슷
- 서브넷마다 하나의 NACL이 있고 새로운 서브넷에는 기본 NACL(Default NACL)이 할당됨
- NACL 규칙 정의에서 규칙에는 숫자가 있고 범위는 1부터 32,766까지
	- 숫자가 낮을수록 우선순위가 높아서 우선순위가 제일 높은 것은 1 가장 낮은 것은 32,766

### Default NACL

![](https://i.imgur.com/0WWdKn5.png)

- 예를 들어 이 CIDR에서 ALLOW를 정의하고 같은 CIDR인 특정 IP를 DENY로 정의하면 ALLOW는 100이고 DENY가 200이니까 IP 주소는 허용됨
	- 100이 200보다 우선하기 때문
- 마지막 규칙은 별표인데, 일치하는 규칙이 없으면 모든 요청을 거부
- AWS는 규칙을 100씩 추가하는 것을 권장
	- 그 사이에 규칙을 추가하기 좋기 때문
- 새로 만들어진 NACL은 기본적으로 모두를 거부
- NACL의 아주 좋은 사용 사례를 들면 **서브넷 수준에서 특정한 IP 주소를 차단하는데 적합**
- NACL은 서브넷 수준에 있으니 공용 서브넷 및 사설 서브넷 등에 위치해 있음
- 기본 NACL은 연결된 서브넷을 가지고 인바운드와 아웃바운드의 모든 요청을 허용하는 특수성을 가짐
	- 이것이 IPv4를 지원하는 기본 NACL의 모습인데 모든 것이 나가고 들어올 수 있음
	- NACL이 모든 것을 드나들도록 허용하지 않으면 AWS를 시작할 때 심각한 디버깅을 해야 함
- 기본 NACL은 매우 개방적
- 기본 NACL을 수정하지 않는 것을 추천
- 사용자 정의 네트워크 ACL이 필요하다면 만들 수 있음
- 시험 문제에서 기본 NACL이 기본적으로 서브넷과 연결된다면, 즉 이 NACL이 서브넷과 연결되어 있다고 말하면 모든 것이 드나들도록 허용된다는 뜻

## Ephemeral Ports

![](https://i.imgur.com/7DoS4ML.png)

- 임시 포트
- 클라이언트와 서버가 연결되면 포트를 사용해야 함
	- 즉 IP 주소와 포트가 있음
- 클라이언트는 규정된 포트의 서버에 연결
	- 서버가 서비스를 올릴 때 클라이언트는 규정된 포트에 접속
- 서버도 응답을 하려면 클라이언트에 연결해야 함
	- 클라이언트는 기본적으로 개방된 포트가 없어서 클라이언트가 서버에 접속할 때 자체적으로 특정한 포트를 열게 됨
	- 이 포트는 임시라서 클라이언트와 서버 간 연결이 유지되는 동안만 열려 있음
- OS별 임시 포트
	- Windows 10: 49152 ~ 65,535
	- Linux: 32768 ~ 60999
	- 등등
- 예시
	- 클라이언트가 웹 서버에 연결되며 웹 서버에는 고정 IP 및 고정 포트가 있음
	- 클라이언트에 IP가 있고 한 번의 요청 또는 연결에만 임시 포트 50105를 개방하려고 함
	- 클라이언트에서 서버로 전송된 요청에는 목적지 IP 정보와 서버가 연결할 목적지 포트, 요청과 관련된 페이로드가 있음
	- 그리고 웹 서버가 다시 회신을 위해서 클라이언트와 연결될 때 소스 IP와 소스 포트 정보, 그리고 서버 포트 정보가 있고 목적지 IP는 11.22.33.44 
		- 마지막으로, 포트가 필요하면 클라이언트가 전송했던 임시 포트를 재사용
	- 임시 포트라고 불리는 것은 연결 수명을 위해서만 할당되는 무작위 포트이기 때문

### NACL with Ephemeral Ports

![](https://i.imgur.com/08xQZwY.png)

- 클라이언트가 데이터베이스에 연결된다고 가정
- 여기 사설 및 공용 서브넷이 있고 각 서브넷에 연결된 NACL이 하나 있음
	- 웹 NACL과 DB NACL
- 클라이언트가 데이터베이스 인스턴스에 연결을 시작하면 허용되어야 하는 규칙
	- 첫 번째 NACL은 포트 3306를 통해 TCP부터 데이터베이스의 서브넷 CIDR까지 아웃바운드를 허용해야 함
		- 그렇지 않으면 요청이 서브넷을 떠나지 않을 것
	- 데이터베이스 측에서는 DB NACL이 웹 서브넷 CIDR에서 포트 3306으로 TCP를 인바운드
- 데이터베이스가 클라이언트로 요청에 회신을 할 때
	- 클라이언트에게는 임시 포트가 있음
		- 그래서 이 요청에 대해 무작위 포트가 할당됨
	- 그러면 DB NACL은 포트 및 임시 포트에서 아웃바운드 TCP를 허용하는데 범위는 1,024에서 65,535
	- 웹 서브넷 CIDR로 아웃바운드 되면 웹 NACL은 DB 서브넷 CIDR의 임시 포트 범위에서 인바운드 TCP를 허용해야 함

### Create NACL rules for each target subnets CIDR

![](https://i.imgur.com/LINEgSy.png)

- NACL의 또 다른 특징은 다중 NACL 및 서브넷이 있다면 각 NACL 조합이 NACL 내에서 허용되어야 한다는 것
	- CIDR 사용 시, 서브넷이 고유의 CIDR을 갖기 때문
- NACL에 서브넷을 추가하면 NACL 규칙도 업데이트해서 연결 조합이 가능한지 확인해야만 함

### Security Group vs NACLs

- 보안 그룹과 NACL의 차이점

|구분|보안 그룹|NACL|
|---|---|---|
|작동 레벨|인스턴스 수준|서브넷 수준|
|규칙|허용 규칙 지원|허용 & 거부 규칙 지원 (특정 IP 주소 거부 가능)|
|상태|상태 유지 (규칙과 무관하게 트래픽 허용)|무상태 (인-아웃바운드 규칙이 매번 평가됨)|

- 보안 그룹에서는 모든 규칙이 평가되고 트래픽 허용 여부를 결정
- NACL에서는 가장 높은 우선순위를 가진 것이 먼저 평가됨
- 보안 그룹은 누군가 지정할 때 EC2 인스턴스에 적용되지만 NACL은 거기에 연결된 서브넷의 모든 EC2 인스턴스에 적용됨

## VPC Peering

![](https://i.imgur.com/Wuxq2k3.png)

![](https://i.imgur.com/DDdniPi.png)

- VPC 피어링은 다양한 리전과 계정에서 VPC를 생성할 수 있음
- AWS 네트워크를 통해 연결하고 싶을 때 사용
	- VPC가 모두 같은 네트워크에서 작동하도록 만들기 위해 사용
- VPC는 다른 리전 및 계정 또는 같은 계정에도 있어서 이들을 연결하거나 연결하지 않고 싶다면 VPC 네트워크 CIDR가 서로 멀리 떨어져야 함
	- 연결했을 때 CIDR가 겹치면 통신을 할 수 없기 때문
- VPC 피어링은 두 VPC 간에 발생하며 전이되지 않음
	- 다시 말해 서로 다른 VPC가 통신하려면 VPC 피어링을 활성화해야 함
- 예시
	- 세 개의 VPC인 A, B, C
	- A와 B 사이에 피어링 연결을 만들 수 있고 이것을 통해 서로 연결됨
	- 그리고 B와 C 사이에​​다른 피어링 연결을 생성
	- 하지만 A와 B, 그리고 B와 C가 연결되어 있더라도 A와 C의 VPC 피어링 연결을 활성화해야 그 둘이 통신을 할 수 있음
	- 중요
- VPC 피어링이 있을 때 활성화는 당연하고 VPC 서브넷 상의 루트 테이블도 업데이트해서 EC2 인스턴스가 서로 통신할 수 있게 함
- 다른 계정 간에도 가능
	- 즉 계정 A에서 계정 B로 VPC를 연결할 수 있음
- 리전 간 연결도 가능
	- 동일 리전의 계정 간 VPC에서도 보안 그룹을 참조할 수도 있음
	- CIDR이나 IP를 소스로 가질 필요가 없고 보안 그룹을 참조할 수도 있음

## VPC Endpoints

![](https://i.imgur.com/HchfOF5.png)

- VPC 엔드포인트
- AWS에서 DynamoDB와 같은 서비스를 이용한다고 하면 퍼블릭 액세스가 가능한데 이것은 NAT Gateway나 인터넷 게이트웨이 또는 인터넷 게이트웨이를 통해 DynamoDB에 액세스할 수 있다는 것
	- 하지만 이 모든 트래픽은 퍼블릭 인터넷을 거쳐서 옴
- 그리고 CloudWatch와 Amazon S3 등의 서비스를 이용할 때는 인터넷을 경유하지 않고 프라이빗 액세스를 원할 수도 있음
- 이때 VPC 엔드포인트를 사용하면 퍼블릭 인터넷을 거치지 않고도 인스턴스에 액세스할 수 있음
- 프라이빗 AWS 네트워크만 거쳐서 바로 해당 서비스에 액세스할 수 있음

### VPC Endpoints (AWS PrivateLink)

![](https://i.imgur.com/04cJqS4.png)


- NAT Gateway가 있는 퍼블릭 서브넷 EC2 인스턴스, 프라이빗 서브넷, 인터넷 게이트웨이가 있음
	- 이런 경우 Amazon SNS 서비스에 세 가지 방법으로 액세스할 수 있음
- 프라이빗 서브넷과 그 안에 있는 EC2 인스턴스에서 Amazon SNS 서비스에 액세스한다고 할 때
	- 먼저 EC2 인스턴스에서 NAT Gateway를 거쳐 인터넷 게이트웨이로 향함
	- 그리고 Amazon SNS 서비스에 퍼블릭으로 액세스
- 퍼블릭 서브넷에 있는 EC2 인스턴스의 경우
	- 인터넷 게이트웨이에서 바로 Amazon SNS 서비스로 향함
	- 이 방법도 괜찮긴 하지만 비용이 많이 듬
	- 일단 NAT Gateway를 거칠 때 비용이 발생하고 그 다음 인터넷 게이트웨이에서는 비용이 발생하지 않지만 허브가 여러 개 있을 테니 어쨌든 효율적이라고는 할 수 없음
- VPC 엔드포인트로 엑세스하는 경우
	- 이때 VPC 엔드포인트는 VPC 내에 배포됨
	- 네트워킹을 구성해서 프라이빗 서브넷에 있는 EC2 인스턴스를 VPC 엔드포인트를 거쳐 직접 Amazon SNS 서비스에 연결할 수 있음
	- 이때 네트워크가 AWS 내에서만 이루어진다는 장점이 있음
- 모든 AWS 서비스는 퍼블릭에 노출되어 있고 퍼블릭 URL을 가짐
- VPC 엔드포인트를 사용하면 AWS PrivateLink를 통해 프라이빗으로 액세스하므로 AWS에 있는 모든 서비스에 액세스할 때 퍼블릭 인터넷을 거치지 않고도 프라이빗 네트워크를 사용할 수 있음
- VPC 엔드포인트는 중복과 수평 확장이 가능하고 인터넷 게이트웨이나 NAT Gateway 없이도 AWS 서비스에 액세스할 수 있게 해주므로 네트워크 인프라를 상당히 간단하게 만들 수 있음
- 문제가 발생하면 VPC에서 DNS 설정 해석이나 라우팅 테이블을 확인하면 됨

### Types of Endpoints

![](https://i.imgur.com/69cmwrI.png)

- 두 가지 VPC 엔드포인트 유형
	- PrivateLink를 이용하는 인터페이스(Interface) 엔드포인트
	- 게이트웨이(Gateway) 엔드포인트
- 인터페이스 엔드포인트
	- ENI를 프로비저닝
	- ENI는 VPC의 프라이빗 IP 주소이자 AWS의 엔트리 포인트
	- ENI가 있으므로 반드시 보안 그룹을 연결해야 함
	- 대부분의 AWS 서비스를 지원하고 청구되는 요금은 시간 단위 또는 처리되는 데이터 GB 단위로 청구됨
	- 도표처럼 프라이빗 서브넷에 EC2 인스턴스가 있고 PrivateLink를 사용하는 인터페이스 유형 VPC 엔드포인트로 ENI를 통하여 이 서비스에 액세스할 수 있음
	- 이 방법은 모든 서비스에서 사용할 수 있음
- 게이트웨이 엔드포인트
	- 게이트웨이 엔드포인트는 특이하게도 게이트웨이를 프로비저닝하는데 이때 게이트웨이는 반드시 라우팅 테이블의 대상이 되어야 함
	- IP 주소를 사용하거나 보안 그룹을 사용하지 않고 라우팅 테이블의 대상이 될 뿐임
		- 이 점을 꼭 기억
	- 게이트웨이 엔드포인트 대상으로는 Amazon S3와 DynamoDB 두 가지가 있음
	- 장점은 요금이 무료이고 라우팅 테이블 액세스일 뿐이므로 자동으로 확장된다는 점
	- Amazon S3와 DynamoDB에서만 지원된다는 점 기억
	- 도식을 보면 게이트웨이 유형 VPC 엔드포인트를 제공하여 Amazon S3이나 DynamoDB에 액세스하고 있음

### Gateway or Interface Endpoint for S3?

![](https://i.imgur.com/e6UiZrK.png)

- 게이트웨이 엔드포인트가 Amazon S3와 DynamoDB만 지원한다면 Amazon S3나 DynamoDB에는 둘 중 어떤 엔드포인트를 써야 할까?
- 시험에서는 게이트웨이 엔드포인트를 선택하시는 것이 유리
	- 라우팅 테이블만 수정하면 되기 때문
	- 그리고 앱에서 Amazon S3에 무료로 액세스할 수도 있음
	- 게이트웨이 엔드포인트는 비용이 들지 않고 확장성이 더 높지만 인터페이스 엔드포인트를 사용하면 비용이 발생
- 게이트웨이 엔드포인트보다 인터페이스 엔드포인트가 권장되는 경우는 온프레미스에서 액세스해야 할 필요가 있을 때 뿐
- 온프레미스에 있는 데이터 센터에 프라이빗으로 액세스해야 하는 경우 Site-to-Site VPN이나 직접 연결 방법이 있음
- 혹은 다른 VPC에 연결할 때도 인터페이스 엔드포인트 유형을 사용하는 편이 좋음

## VPC Flow Logs

![](https://i.imgur.com/KagFiin.png)

- VPC Flow Logs를 사용하면 인터페이스로 들어오는 IP 트래픽에서 정보를 포착할 수 있음
- VPC 수준이나 서브넷 수준 또는 탄력적 네트워크 인터페이스 수준에서 포착할 수 있음
	- 이렇게 세 가지 종류의 흐름 로그를 포착할 수 있음
- 이걸 사용하면 VPC에서 일어나는 연결 문제를 모니터링하고 해결하는 데 아주 유용
	- 그런 흐름 로그를 Amazon S3, CloudWatch Logs, Kinesis Data Firehose에 전송할 수 있음
	- 또 ELB, RDS, ElastiCache, Redshift, WorkSpaces, NATGW, Transit Gateway 등 AWS의 관리형 인터페이스에도 전송할 수 있음

### VPC Flow Logs Syntax

![](https://i.imgur.com/224u2H1.png)

- 버전, 인터페이스 ID, 소스 주소, 대상 주소, 소스 포트, 대상 포트, 프로토콜, 패킷, 바이트 수, 시작, 끝, 액션, 로그 상태
	- VPC로 가는 네트워크 패킷에 관한 메타데이터
- 이걸 전체적으로 다 외울 필요는 없음
- 소스 주소와 대상 주소는 문제가 있는 IP를 식별하는 데 도움
	- 어떤 IP가 반복적으로 거부되는 걸 보면, 그 IP에 문제가 있을 수 있음
	- 특정한 IP로부터 공격을 받고 있을 수도 있음
- 소스 포트와 대상 포트는 여러분이 문제가 있는 포트를 식별하도록 도와줌
	- 액션은 수락 또는 거부
	- 보안 그룹 또는 NACL 수준에서 성공 혹은 실패 여부를 알려주는 것
- VPC Flow Logs를 이용해서 사용 패턴을 분석하거나 악의적인 행동이나 포트 스캔 등을 탐지할 수 있음
- Flow Logs를 쿼리하는 방법
	- 최적의 방법은 Athena를 S3에 사용하는 방법
	- 스트리밍 분석을 원한다면 CloudWatch Logs Insights를 사용할 수도 있음

### Troubleshoot SG & NACL issues

![](https://i.imgur.com/d4SSclh.png)

- Flow Logs를 이용해서 어떻게 보안 그룹과 NACL이슈를 해결하는 방법

예, 우린 ACTION 필드를 확인해요, 그럼 NACL과 서브넷에 유입되는 통상적인 요청을

한번 살펴보죠

기억하시겠지만 여러분의 NACL은 상태가 없고요, 보안 그룹에는 상태가 있어요

그럼 어떻게 될까요?

만일 Inbound REJECT가 되면 어떨까요? 외부로부터 우리 EC2 인스턴스로 유입되는 요청이

거절된 걸 볼 수 있는데요, 이 그래프에서 보면 NACL이 요청을 거부하거나

보안 그룹이 요청을 거부한다는 의미예요

이해가 되죠, 그렇죠?

하지만 만일 Inbound ACCEPT, Outbound REJECT라면 NACL만의 이슈라는 얘기가 되죠

왜일까요?

그 이유는 보안 그룹은 상태가 있기 때문이예요

그리고 ACCEPT에서 알 수 있듯이 인바운드가 허용된다면 보안 그룹의 상태 덕분에 아웃바운드도

자동적으로 허용되죠

그럼 나가는 요청에 대해서도 비슷한 분석이 가능해요

이 도표는 이미 알고 있고요

그럼 만일 Outbound REJECT라면 NACL이나 보안 그룹에 이슈가 있는 거고요

하지만 Outbound ACCEPT이고 Inbound REJECT라면 반드시 NACL에 이슈가 있는 것이예요

그럼 여러분의 VPC Flow Logs의 몇 가지 아키텍처를 살펴볼까요? 아시는 것처럼 흐름 로그가 CloudWatch Logs로

갈 수 있고요

그럼 우린 CloudWatch Contributor Insights라는 걸 이용해서, 예를 들어 여러분의 VPC나 여러분이 원하는 것에 대한

네트워크에 가장 많이 기여하는 상위 10개 IP 주소를 확인할 수 있어요

또 VPC Flow Logs를 사용해서 그것들을 역시 CloudWatch Logs로 전송할 수도 있고요

여기서 우린 메트릭 필터를 설정해서 예를 들어 SSH 또는 RDP 프로토콜을 검색할 수 있죠

그리고 평소보다 SSH 또는 RDP가 있다는 걸 알게 되면, CloudWatch Alarm을 트리거할 수 있고요

Amazon SNS 토픽에 경보를 전송할 수 있어요, 네트워크에서 뭔가 수상한 게 진행되고 있다는 얘기니까요

또는 VPC Flow Logs를 사용하고 모든 걸 S3 버킷에 전송해서 저장할 수 있어요, 그리고 Amazon Athena를 사용해서

SQL로 된 VPC Flow Logs를 분석할 수 있고요, Amazon QuickSight로 그걸 시각화할 수도 있죠

그럼 VPC Flow Logs에 대한 내용은 여기까지고요

강의가 마음에 드셨기를 바라요, 저는 다음 강의에서 뵐게요

