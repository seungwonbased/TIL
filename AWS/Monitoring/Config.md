# AWS Config

- Config는 AWS 내 리소스에 대한 감사와 규정 준수 여부를 기록할 수 있게 해주는 서비스
- 설정된 규칙에 기반해 구성과 구성의 시간에 따른 변화를 기록할 수 있으며 이를 통해 필요할 경우 인프라를 빠르게 롤백하고 문제점을 찾아낼 수 있음
- Config로 해결할 수 있는 질문
	- '보안 그룹에 제한되지 않은 SSH 접근이 있나?'
	- '버킷에 공용 액세스가 있나?'
	- '시간이 지나며 변화한 ALB 구성이 있나?'
	- 이럴 경우 규칙이 규정을 준수하든 아니든 변화가 생길 때마다 SNS 알림을 받을 수 있음
- Config는 리전별 서비스이기 때문에 모든 리전별로 구성해야 하며 데이터를 중앙화하기 위해 리전과 계정 간 데이터를 통합할 수 있음
- 또한 모든 리소스의 구성을 S3에 저장해 나중에 분석할 수도 있음
	- 예를 들어 Athena 같은 서버리스 쿼리 엔진을 통해 분석 가능

## Config Rules

- Config에 적용되는 규칙들
	- AWS 관리형 Config 규칙
		- 여기에는 75종의 규칙이 있음
	- 스스로 Config 규칙을 만들어도 됨
		- 그런 경우 AWS Lambda를 이용해 스스로 규칙을 정의해야 함
		- 예를 들어 각 EBS 디스크가 gp2 유형인지 평가할 수 있고, 개발 계정의 EC2 인스턴스가 t2.micro 유형인지 평가할 수도 있음
- 몇몇 규칙들은 구성이 변화할 때마다 평가되거나 트리거 되곤 함
	- 예를 들어 EBS 디스크에 새 구성이 생길 때마다 EBS 디스크의 유형을 평가를 하거나 정기적으로 규칙이 평가되도록 만들 수도 있음
		- 예를 들어 2시간마다 EBS 디스크가 gp2 유형인지 평가하는 식
- Config 규칙은 규정 준수를 위한 것
	- 어떤 동작을 미리 예방하지는 못함
	- 어떤 것도 차단할 수 없음
	- IAM 같은 보안 메커니즘을 대신할 수 없음
- 하지만 구성의 개요와 리소스의 규정 준수 여부는 Config 규칙을 통해 알 수 있음
- Config는 결제해야 하며 굉장히 비싸질 수 있음
	- 각 리전당 기록된 구성 항목별로 3센트를 지불해야 하고 리전당 Config 규칙 평가별로 0.1센트를 내야 함

### AWS Config Resource

![config](https://github.com/seungwonbased/TIL/blob/main/AWS/assets/config1.png)

- Config 리소스는 리소스의 규정 준수 여부를 시간 별로 볼 수 있음
- 예시에서 보안 그룹은 규정 미준수 상태
- 리소스 구성도 시간별로 볼 수 있음
	- 언제, 누가 변경했는지 등
- 이걸 CloudTrail과 연결해 리소스에 대한 API 호출을 볼 수 있음
	- 그러므로 일어나는 모든 일을 전부 파악할 수 있음

### Config Rules - Remediations

![config](https://github.com/seungwonbased/TIL/blob/main/AWS/assets/config2.png)

- Config 내에서 행동을 차단할 수는 없지만 SSM 자동화 문서를 이용해서 규정을 준수하지 않는 리소스를 수정할 수 있음
- 예시
	- IAM 액세스 키의 만료 여부를 모니터링한다고 가정
	- 예를 들어 키가 90일 이상 보관된 경우로 이런 경우는 규정을 준수하지 않은 상태
	- 규정 미준수를 예방하지는 못하지만 리소스가 규정을 미준수할 때마다 수정 작업을 트리거 할 수 있음
		- RevokeUnusedIAM, UserCredentials 라는 이름의 SSM 문서가 있고 이걸 이용한다고 가정
			- 그리고 이게 리소스에 적용된다고 가정
		- 이 경우 SSM 문서가 IAM 액세스 키를 비활성화함
			- AWS 관리형 문서를 사용하든 본인만의 자동화 문서를 만들어 사용하든 규정을 준수하지 않는 리소스를 수정할 수 있다는 것
	- 그리고 만약 계속 스크립트를 하고 싶다면 람다 함수를 실행하는 문서를 생성해서 원하는 작업을 수행할 수도 있음
	- 수정 작업은 재시도 될 수 있음
		- 리소스를 자동 수정했음에도 여전히 규정을 미준수한다면 5번까지 재시도될 수 있음

### Config Rules - Notifications

![config](https://github.com/seungwonbased/TIL/blob/main/AWS/assets/config3.png)

- EventBridge를 사용해 리소스가 규정을 미준수했을 때마다 알림을 보낼 수 있음
- 예를 들어 보안 그룹을 모니터링하다가 규정 미준수 상태가 됐다면 EventBridge에서 이벤트를 트리거 해서 원하는 리소스에 넘길 수 있음
- 또는 모든 구성 변경과 모든 리소스의 규정 준수 여부 알림을 Config에서 SNS로 보낼 수도 있음
	- 한 구성 항목이 있고 특정 이벤트에만 적용되게 필터링 하고 싶다면 SNS 필터링을 사용해 SNS 주제를 필터링할 수 있음
	- 그리고 알림을 전송할 수 있음
		- 예를 들면 관리자 이메일이나 Slack 채널 등으로

