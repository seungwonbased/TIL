# Singleton Container

# Singleton pattern

스프링에서의 싱글톤 패턴은 **객체를 단 한 번만 생성하고, 생성된 객체를 계속해서 재사용하여 메모리 사용을 최적화하는 방식**입니다. 이를 스프링 싱글톤 패턴이라고 합니다.

스프링에서 싱글톤 패턴을 적용하면 **객체 생성 비용을 줄일 수 있으며, 메모리 사용을 최적화**할 수 있습니다. 객체 생성 비용이 크거나, 객체 생성에 시간이 오래 걸리는 경우, 싱글톤 패턴을 적용하면 애플리케이션의 성능을 향상시킬 수 있습니다.

또한, 싱글톤 패턴을 이용하면 애플리케이션 전역에서 하나의 객체만 사용하기 때문에, **객체 간의 의존성 관리가 용이**해집니다. 객체 간의 의존성이 적어지면 유지보수성이 높아지고, 코드의 가독성도 좋아집니다.

스프링에서는 기본적으로 빈(bean)의 범위(scope)를 싱글톤(singleton)으로 지정하여 싱글톤 패턴을 적용합니다. 빈의 범위를 지정하지 않으면 기본적으로 싱글톤 범위가 적용됩니다.

하지만, 싱글톤 패턴이 가지는 단점으로는 다중 스레드 환경에서 안전하지 않다는 점이 있습니다. 따라서, 동시에 여러 스레드에서 해당 객체에 접근하는 경우 동기화 문제가 발생할 수 있으므로, 필요에 따라 동기화 처리를 해주어야 합니다.

## 싱글톤 패턴의 문제점

- 의존관계상 클라이언트가 구체 클래스에 의존 → DIP 위반
- 클라이언트가 구체 클래스에 의존해서 OCP 원칙 위반할 가능성
- 테스트하기 어려움
- 내부 속성 변경 및 초기화 어려움
- private 생성자 때문에 자식 클래스를 만들기 어려움
- 결론적으로 유연성이 떨어지게 됨
- 안티패턴으로 불리기도 함

# Singleton Container

- 싱글톤 패턴의 문제점을 해결하면서, 객체 인스턴스를 싱글톤으로 관리하는 컨테이너

스프링 싱글톤 컨테이너는 스프링 프레임워크에서 객체를 생성하고 관리하는 컨테이너 중 하나입니다. 이 컨테이너는 스프링에서 사용되는 객체들을 생성하고 이들 객체를 싱글톤으로 관리합니다.

싱글톤 패턴은 객체를 단 하나의 인스턴스만 생성하도록 보장하는 디자인 패턴입니다. 스프링 싱글톤 컨테이너는 이러한 싱글톤 패턴을 이용하여 객체를 생성하고 관리합니다. 스프링 싱글톤 컨테이너는 객체를 생성할 때 미리 생성된 객체가 있는지 확인하고, 있다면 해당 객체를 반환합니다. 미리 생성된 객체가 없다면 객체를 생성하고 이를 관리합니다.

스프링 싱글톤 컨테이너는 객체의 라이프 사이클을 관리하기 위해 빈 생명주기 콜백 메서드를 제공합니다. 이 메서드를 이용하여 객체의 초기화나 소멸과 같은 작업을 수행할 수 있습니다.

스프링 싱글톤 컨테이너는 빈으로 등록된 객체에 대한 의존성 주입도 처리합니다. 이를 통해 객체들 간의 의존성을 쉽게 관리할 수 있습니다.

스프링 싱글톤 컨테이너는 기본적으로 스레드 안전성을 보장합니다. 여러 스레드에서 동시에 접근하더라도 스프링 컨테이너는 항상 동일한 객체 인스턴스를 반환합니다. 이를 통해 객체의 일관성과 안정성을 보장할 수 있습니다.

마지막으로, 스프링 싱글톤 컨테이너는 빈을 등록하고 관리하기 위한 다양한 방법을 제공합니다. XML, JavaConfig, 어노테이션 등 다양한 방식으로 빈을 등록하고 이를 관리할 수 있습니다.

# 싱글톤 방식의 주의점

싱글톤 패턴이든, 스프링에서 사용하는 싱글톤 컨테이너든, 객체 인스턴스를 하나만 생성해서 공유하는 싱글톤 방식은 여러 클라이언트가 하나의 같은 객체 인스턴스를 공유하기 때문에 **`싱글톤 객체는 상태를 유지(stateful)하도록 설계하면 안된다!`**

## Stateless 설계

- 특정 클라이언트에 의존적인 필드가 있으면 안 됨
- 특정 클라이언트가 값을 변경할 수 있는 필드가 있으면 안 됨
- 가급적 읽기만 가능해야 함
- 필드 대신에 자바에서 공유되지 않는 지역변수, 파라미터, ThreadLocal 등을 사용해야 함

<aside>
🚨 스프링 빈의 필드에 공유 값을 설정하면 정말 큰 장애가 발생할 수도 있음

</aside>

# @Configuration과 싱글톤

## @Configuration과 바이트 코드 조작의 마법

스프링 컨테이너는 싱글톤 레지스트리다. 따라서 스프링 빈이 싱글톤이 되도록 보장해주어야 한다. 그런데 스프링이 자바 코드까지 어떻게 조작하기는 어렵다. 그래서 스프링은 클래스의 바이트 코드를 조작하는 라이브러리를 사용한다. 모든 비밀은 **`@Configuration`**을 적용한 **`AppConfig`** 클래스에 있다

스프링은 **`CGLIB`**라는 바이트 코드 조작 라이브러리를 사용해서 **`AppConfig`** 클래스를 상속 받은 임의의 다른 클래스를 만들고, 그 다른 클래스를 스프링 빈으로 등록하여 이 문제를 해결한다. 

**`@Bean`**이 붙은 메서드마다 이미 스프링 빈이 존재하면 존재하는 빈을 반환하고 스프링 빈이 없으면 생성해서 스프링 빈으로 등록하고 반환하는 코드가 동적으로 생성 → 덕분에 싱글톤 보장

## 정리

- **`@Bean`**만 사용해도 스프링 빈으로 등록되지만, 싱글톤을 보장하지는 않음
- 크게 고민할 거 없이 스프링 설정 정보는 항상 **`@Configuration`**을 사용